\begin{Verbatim}[commandchars=\\\{\}]
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Ast}
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Loc}
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Typ}
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Utils}
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Printer}

\PYGcolorful{k}{module} \PYGcolorful{n+nc}{A} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{AST}
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{A}
\PYGcolorful{k}{module} \PYGcolorful{n+nc}{T} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{TypedAST}


\PYGcolorful{c}{(** General error functions *)}

\PYGcolorful{k}{let} \PYGcolorful{n}{error} \PYGcolorful{n}{msg} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
  \PYGcolorful{k}{raise} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Typing\PYGcolorfulZus{}error} \PYGcolorful{o}{(}\PYGcolorful{n}{msg}\PYGcolorful{o}{,} \PYGcolorful{n}{loc}\PYGcolorful{o}{))}


\PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}record} \PYGcolorful{n}{typ} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{typ} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Trecord} \PYGcolorful{n}{r} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{r}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A record was expected\PYGcolorfulZdq{}} \PYGcolorful{n}{loc}

\PYGcolorful{k}{let} \PYGcolorful{n}{wrong\PYGcolorfulZus{}type} \PYGcolorful{n}{t\PYGcolorfulZus{}exp} \PYGcolorful{n}{t\PYGcolorfulZus{}proc} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{print\PYGcolorfulZus{}typ\PYGcolorfulZus{}to\PYGcolorfulZus{}str} \PYGcolorful{o}{=} \PYGcolorful{n}{print\PYGcolorfulZus{}to\PYGcolorfulZus{}string} \PYGcolorful{n}{print\PYGcolorfulZus{}typ} \PYGcolorful{k}{in}
  \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf}
           \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression has type \PYGcolorfulZpc{}s but was expected of type \PYGcolorfulZpc{}s\PYGcolorfulZdq{}}
           \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}typ\PYGcolorfulZus{}to\PYGcolorfulZus{}str} \PYGcolorful{n}{t\PYGcolorfulZus{}proc}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}typ\PYGcolorfulZus{}to\PYGcolorfulZus{}str} \PYGcolorful{n}{t\PYGcolorfulZus{}exp}\PYGcolorful{o}{))} \PYGcolorful{n}{loc}


\PYGcolorful{c}{(** The environment module *)}

\PYGcolorful{k}{module} \PYGcolorful{n+nc}{Env} \PYGcolorful{o}{:} \PYGcolorful{k}{sig}
  \PYGcolorful{k}{type} \PYGcolorful{n}{t}

  \PYGcolorful{k}{val} \PYGcolorful{n}{new\PYGcolorfulZus{}env} \PYGcolorful{o}{:} \PYGcolorful{n}{t}

  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{level} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ}
  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{level} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ}
  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{level} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ\PYGcolorfulZus{}annot} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ}

  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{level} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{bool} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{bool} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{bool} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{param} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}subtypes} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}

  \PYGcolorful{k}{val} \PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{loc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{unit}
  \PYGcolorful{k}{val} \PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{unit}
  \PYGcolorful{k}{val} \PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{loc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{unit}

  \PYGcolorful{k}{val} \PYGcolorful{n}{level} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{level}
  \PYGcolorful{k}{val} \PYGcolorful{n}{incr\PYGcolorfulZus{}level} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{deco\PYGcolorfulZus{}level} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident}
\PYGcolorful{k}{end} \PYGcolorful{o}{=} \PYGcolorful{k}{struct}
  \PYGcolorful{k}{type} \PYGcolorful{n}{constr} \PYGcolorful{o}{=}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Ta} \PYGcolorful{c}{(* type\PYGcolorfulZus{}annot *)}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Id} \PYGcolorful{c}{(* variable or procedure/fonction *)}
  \PYGcolorful{k}{type} \PYGcolorful{n}{obj} \PYGcolorful{o}{=} \PYGcolorful{n}{constr} \PYGcolorful{o}{*} \PYGcolorful{n}{typ}

  \PYGcolorful{k}{module} \PYGcolorful{n+nc}{Sset} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Set}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Make}\PYGcolorful{o}{(}\PYGcolorful{n+nc}{String}\PYGcolorful{o}{)}
  \PYGcolorful{k}{module} \PYGcolorful{n+nc}{Smap} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Map}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Make}\PYGcolorful{o}{(}\PYGcolorful{n+nc}{String}\PYGcolorful{o}{)}
  \PYGcolorful{k}{module} \PYGcolorful{n+nc}{Tset} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Set}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Make}\PYGcolorful{o}{(}\PYGcolorful{k}{struct} \PYGcolorful{k}{type} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n}{typ} \PYGcolorful{o}{*} \PYGcolorful{n}{typ}
      \PYGcolorful{k}{let} \PYGcolorful{n}{compare} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Pervasives}\PYGcolorful{p}{.}\PYGcolorful{n}{compare} \PYGcolorful{k}{end}\PYGcolorful{o}{)}

  \PYGcolorful{k}{type} \PYGcolorful{n}{map} \PYGcolorful{o}{=} \PYGcolorful{o}{(}\PYGcolorful{n}{obj} \PYGcolorful{o}{*} \PYGcolorful{n}{level}\PYGcolorful{o}{)} \PYGcolorful{k+kt}{list} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{t}
  \PYGcolorful{k}{type} \PYGcolorful{n}{t} \PYGcolorful{o}{=} 
    \PYGcolorful{o}{\PYGcolorfulZob{}}
      \PYGcolorful{n}{objs}     \PYGcolorful{o}{:} \PYGcolorful{n}{map}\PYGcolorful{o}{;}    \PYGcolorful{c}{(* Maps an identifier to its type *)}
      \PYGcolorful{n}{consts}   \PYGcolorful{o}{:} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;} \PYGcolorful{c}{(* Set of variables that shouldn\PYGcolorfulZsq{}t be modified *)}
      \PYGcolorful{n}{notdef}   \PYGcolorful{o}{:} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;} \PYGcolorful{c}{(* Set of types that haven\PYGcolorfulZsq{}t been defined yet *)}
      \PYGcolorful{n}{subtypes} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;} \PYGcolorful{c}{(* Contains (t1, t2) pairs where t2 is a subtype of t1 *)}
      \PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{:} \PYGcolorful{n}{level}\PYGcolorful{o}{;}
    \PYGcolorful{o}{\PYGcolorfulZcb{}}


  \PYGcolorful{k}{let} \PYGcolorful{n}{to\PYGcolorfulZus{}id} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{o}{((}\PYGcolorful{n+nc}{Id}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{to\PYGcolorfulZus{}ta} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{o}{((}\PYGcolorful{n+nc}{Ta}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{of\PYGcolorfulZus{}id} \PYGcolorful{o}{(}\PYGcolorful{n}{obj} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{match} \PYGcolorful{n}{obj} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Id}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Ta}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is a type but an identifier is expected\PYGcolorfulZdq{}}
                          \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
  \PYGcolorful{k}{let} \PYGcolorful{n}{of\PYGcolorfulZus{}ta} \PYGcolorful{o}{(}\PYGcolorful{n}{obj} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{match} \PYGcolorful{n}{obj} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Id}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is an identifier but a type is expected\PYGcolorfulZdq{}}
                          \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Ta}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}


  \PYGcolorful{k}{let} \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{(}\PYGcolorful{n}{ts}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{In}\PYGcolorful{o}{))} \PYGcolorful{n}{ts}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{reserved} \PYGcolorful{o}{=} \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}character\PYGcolorfulZsq{}val\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{([}\PYGcolorful{k+kt}{int}\PYGcolorful{o}{],}  \PYGcolorful{k+kt}{char}\PYGcolorful{o}{));}
                  \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}put\PYGcolorfulZdq{}}\PYGcolorful{o}{,}           \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{([}\PYGcolorful{k+kt}{char}\PYGcolorful{o}{],} \PYGcolorful{n}{null}\PYGcolorful{o}{));}
                  \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}new\PYGcolorfulZus{}line\PYGcolorfulZdq{}}\PYGcolorful{o}{,}      \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{(}\PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{,}     \PYGcolorful{n}{null}\PYGcolorful{o}{));}
                 \PYGcolorful{o}{]}

  \PYGcolorful{k}{let} \PYGcolorful{n}{unops}    \PYGcolorful{o}{=} \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}not\PYGcolorfulZdq{}}\PYGcolorful{o}{,}           \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{([}\PYGcolorful{k+kt}{bool}\PYGcolorful{o}{],} \PYGcolorful{k+kt}{bool}\PYGcolorful{o}{))]} 

  \PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}binop} \PYGcolorful{o}{=} \PYGcolorful{k}{function}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Beq} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bneq} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}                            \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Blt} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bleq} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bgt} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bgeq} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}               \PYGcolorful{o}{([}\PYGcolorful{k+kt}{int}\PYGcolorful{o}{;}  \PYGcolorful{k+kt}{int}\PYGcolorful{o}{],}  \PYGcolorful{k+kt}{bool}\PYGcolorful{o}{)}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bplus} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bminus} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Btimes} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bdiv} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Brem} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{([}\PYGcolorful{k+kt}{int}\PYGcolorful{o}{;}  \PYGcolorful{k+kt}{int}\PYGcolorful{o}{],}  \PYGcolorful{k+kt}{int}\PYGcolorful{o}{)}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Band} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Band\PYGcolorfulZus{}then} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bor} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bor\PYGcolorfulZus{}else} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}     \PYGcolorful{o}{([}\PYGcolorful{k+kt}{bool}\PYGcolorful{o}{;} \PYGcolorful{k+kt}{bool}\PYGcolorful{o}{],} \PYGcolorful{k+kt}{bool}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{binops} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{b} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}to\PYGcolorfulZus{}string} \PYGcolorful{n}{print\PYGcolorfulZus{}binop} \PYGcolorful{n}{b}\PYGcolorful{o}{,}
                                   \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}binop} \PYGcolorful{n}{b}\PYGcolorful{o}{)))}
                 \PYGcolorful{o}{[}\PYGcolorful{n+nc}{Blt}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bleq}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bgt}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bgeq}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bplus}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bminus}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Btimes}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bdiv}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Brem}\PYGcolorful{o}{;}
                  \PYGcolorful{n+nc}{Band}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Band\PYGcolorfulZus{}then}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bor}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bor\PYGcolorfulZus{}else}\PYGcolorful{o}{]}

  \PYGcolorful{k}{let} \PYGcolorful{n}{formate} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{k}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{k}\PYGcolorful{o}{,} \PYGcolorful{o}{[(}\PYGcolorful{n}{to\PYGcolorfulZus{}id} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{n}{k} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{;}
                                                      \PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)]))}
  \PYGcolorful{k}{let} \PYGcolorful{n}{builtins\PYGcolorfulZus{}ids} \PYGcolorful{o}{=} \PYGcolorful{n}{formate} \PYGcolorful{o}{(}\PYGcolorful{n}{reserved} \PYGcolorful{o}{@} \PYGcolorful{n}{unops} \PYGcolorful{o}{@} \PYGcolorful{n}{binops}\PYGcolorful{o}{)}

  \PYGcolorful{k}{let} \PYGcolorful{n}{primitives} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{,} \PYGcolorful{o}{[(}\PYGcolorful{n}{to\PYGcolorfulZus{}ta} \PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)]))}
                     \PYGcolorful{o}{[}\PYGcolorful{n}{null}\PYGcolorful{o}{;}\PYGcolorful{k+kt}{int}\PYGcolorful{o}{;} \PYGcolorful{k+kt}{char}\PYGcolorful{o}{;} \PYGcolorful{k+kt}{bool}\PYGcolorful{o}{]}

  \PYGcolorful{k}{let} \PYGcolorful{n}{new\PYGcolorfulZus{}env} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{objs} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{of\PYGcolorfulZus{}list} \PYGcolorful{o}{(}\PYGcolorful{n}{builtins\PYGcolorfulZus{}ids} \PYGcolorful{o}{@} \PYGcolorful{n}{primitives}\PYGcolorful{o}{);}
                  \PYGcolorful{n}{consts} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{empty}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{empty}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{subtypes} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{empty}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{;}
                \PYGcolorful{o}{\PYGcolorfulZcb{}}


  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{lvl} \PYGcolorful{n}{id} \PYGcolorful{n}{id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{n}{of\PYGcolorfulZus{}id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Unknown \PYGcolorfulZpc{}s: \PYGcolorfulZpc{}s\PYGcolorfulZdq{}} \PYGcolorful{n}{id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
                          \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{o} \PYGcolorful{o}{=} \PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{snd} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZlt{}=} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{n}{l}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{n}{of\PYGcolorfulZus{}id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{n}{o} \PYGcolorful{n}{id}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A variable cannot depend on its own initialization\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{else} \PYGcolorful{n}{get\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{lvl} \PYGcolorful{n}{id} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}identifier\PYGcolorfulZdq{}} \PYGcolorful{n}{of\PYGcolorfulZus{}id}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{n}{ti} \PYGcolorful{o}{=}
    \PYGcolorful{n}{get\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{lvl} \PYGcolorful{n}{ti} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}defined type\PYGcolorfulZdq{}} \PYGcolorful{n}{of\PYGcolorfulZus{}ta}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{n}{ta} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{k}{then}
      \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef}
      \PYGcolorful{k}{then} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZdq{}} \PYGcolorful{n}{lvl}\PYGcolorful{o}{;}
             \PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Taccess} \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZcb{}}
      \PYGcolorful{k}{else} \PYGcolorful{n}{to\PYGcolorfulZus{}access} \PYGcolorful{o}{(}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{)}
    \PYGcolorful{k}{else} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}


  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{o}{?(}\PYGcolorful{n}{force} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{n}{typ} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs} \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{lvl\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n}{snd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{snd} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZlt{}=} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{n}{l}\PYGcolorful{o}{)}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{\PYGcolorfulZhy{}}\PYGcolorful{l+m+mi}{1} \PYGcolorful{k}{in}
    \PYGcolorful{k}{if} \PYGcolorful{n}{lvl\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{lvl} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{not} \PYGcolorful{n}{force}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already defined at this level\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{o}{(}\PYGcolorful{n}{to\PYGcolorfulZus{}id} \PYGcolorful{n}{typ}\PYGcolorful{o}{,} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{o}{::} \PYGcolorful{n}{l} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{sort} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{n}{o\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{compare} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o}\PYGcolorful{o}{))} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{objs} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}\PYGcolorful{o}{;}
               \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{remove} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{force} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{ta} \PYGcolorful{n}{typ} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs} \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n+nb+bp}{()} \PYGcolorful{o}{=} \PYGcolorful{k}{try}
        \PYGcolorful{k}{if} \PYGcolorful{n}{snd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{hd} \PYGcolorful{n}{l}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{not} \PYGcolorful{n}{force}
        \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already defined at this level\PYGcolorfulZdq{}}
                      \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Failure} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{c}{(*\PYGcolorfulZdq{}hd\PYGcolorfulZdq{}*)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{o}{(}\PYGcolorful{n}{to\PYGcolorfulZus{}ta} \PYGcolorful{n}{typ}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{o}{::} \PYGcolorful{n}{l} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{stable\PYGcolorfulZus{}sort} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{n}{o\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{compare} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o}\PYGcolorful{o}{))} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{objs} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}\PYGcolorful{o}{;}
               \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{remove} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{n}{env} \PYGcolorful{o}{?}\PYGcolorful{n}{force} \PYGcolorful{o}{(}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?}\PYGcolorful{n}{force} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{n}{t} \PYGcolorful{k}{in}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{k}{with} \PYGcolorful{n}{consts} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{m} \PYGcolorful{k}{with}
                    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{InOut} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts}
                    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{In}    \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{n}{t} \PYGcolorful{k}{then} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts}
                      \PYGcolorful{k}{else} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{consts} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{remove} \PYGcolorful{n}{id} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}subtypes} \PYGcolorful{n}{env} \PYGcolorful{n}{t1} \PYGcolorful{n}{t2} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{sub} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{fold} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{t3}\PYGcolorful{o}{,} \PYGcolorful{n}{t4}\PYGcolorful{o}{)} \PYGcolorful{n}{tset} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{t2} \PYGcolorful{o}{=} \PYGcolorful{n}{t3} \PYGcolorful{k}{then} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{,} \PYGcolorful{n}{t4}\PYGcolorful{o}{)} \PYGcolorful{n}{tset}
                          \PYGcolorful{k}{else} \PYGcolorful{k}{if} \PYGcolorful{n}{t1} \PYGcolorful{o}{=} \PYGcolorful{n}{t4} \PYGcolorful{k}{then} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{o}{(}\PYGcolorful{n}{t3}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{)} \PYGcolorful{n}{tset} \PYGcolorful{k}{else} \PYGcolorful{n}{tset}\PYGcolorful{o}{)}
                \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{subtypes} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{)} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{subtypes}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{subtypes} \PYGcolorful{o}{=} \PYGcolorful{n}{sub} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{k}{then}
      \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already declared at this level\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{try}
      \PYGcolorful{k}{if} \PYGcolorful{n}{snd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{hd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}\PYGcolorful{o}{))} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}
      \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already defined at this level\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
             \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{k}{else} \PYGcolorful{k}{raise} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found}
    \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{o}{\PYGcolorfulZcb{}}


  \PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{n}{env} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
    \PYGcolorful{k}{try}
      \PYGcolorful{k}{let} \PYGcolorful{n}{id} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{choose} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{k}{in}
      \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s has not been defined before the \PYGcolorfulZbs{}}
\PYGcolorful{l+s+s2}{                             next level of declarations\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{)} \PYGcolorful{n}{loc}
    \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}

  \PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s cannot be modified, it has been \PYGcolorfulZbs{}}
\PYGcolorful{l+s+s2}{                                declared In or is a counter variable\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
           \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}

  \PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t1} \PYGcolorful{n}{t2} \PYGcolorful{n}{loc2} \PYGcolorful{o}{=}
    \PYGcolorful{c}{(* t2 is a subtype of t1? *)}
    \PYGcolorful{k}{match} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{.}\PYGcolorful{n}{def}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{.}\PYGcolorful{n}{def}\PYGcolorful{o}{)} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Taccess} \PYGcolorful{o}{\PYGcolorfulZus{},} \PYGcolorful{n+nc}{Tnull}\PYGcolorful{o}{)} \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Tnull}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Taccess} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}
    \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{not} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{)} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{subtypes}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{t1} \PYGcolorful{o}{\PYGcolorfulZlt{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t2}
      \PYGcolorful{k}{then} \PYGcolorful{n}{wrong\PYGcolorfulZus{}type} \PYGcolorful{n}{t1} \PYGcolorful{n}{t2} \PYGcolorful{n}{loc2}


  \PYGcolorful{k}{let} \PYGcolorful{n}{level} \PYGcolorful{n}{env} \PYGcolorful{o}{=}
    \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}

  \PYGcolorful{k}{let} \PYGcolorful{n}{incr\PYGcolorfulZus{}level} \PYGcolorful{n}{env} \PYGcolorful{o}{=}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{+} \PYGcolorful{l+m+mi}{1} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{deco\PYGcolorfulZus{}level} \PYGcolorful{n}{env} \PYGcolorful{n}{s} \PYGcolorful{o}{=}
    \PYGcolorful{n}{decorate} \PYGcolorful{n}{s} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}
\PYGcolorful{k}{end}


\PYGcolorful{c}{(** Typing of expressions *)}

\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}ident} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
  \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id}\PYGcolorful{o}{)} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{)}


\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{ta} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}annot}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
  \PYGcolorful{o}{((\PYGcolorfulZob{}} \PYGcolorful{n}{typ\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{;}
      \PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{o}{=} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}annot}\PYGcolorful{o}{),}
   \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{ta}\PYGcolorful{o}{)}

\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}annotated} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{a} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{annotated}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{ta\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta} \PYGcolorful{k}{in}
  \PYGcolorful{o}{((\PYGcolorfulZob{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{=} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{;}
      \PYGcolorful{n}{ta}    \PYGcolorful{o}{=} \PYGcolorful{n}{ta\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{annotated}\PYGcolorful{o}{),} \PYGcolorful{n}{t}\PYGcolorful{o}{)}

\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}const} \PYGcolorful{o}{=} \PYGcolorful{k}{function}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cint}  \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{int}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cchar} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{char}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cbool} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{bool}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cnull}   \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{null}

\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}field} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{n}{fields} \PYGcolorful{o}{(}\PYGcolorful{n}{f} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident\PYGcolorfulZus{}decl}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
  \PYGcolorful{k}{try}
    \PYGcolorful{k}{let} \PYGcolorful{n}{a} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{a} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{fields} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{o}{(}\PYGcolorful{n}{map\PYGcolorfulZus{}ta} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta}\PYGcolorful{o}{)}
  \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Record \PYGcolorfulZpc{}s has no field \PYGcolorfulZpc{}s\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
                   \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}


\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{lv\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{lv} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{lv} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Lident} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env} \PYGcolorful{n}{id}\PYGcolorful{o}{;}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Lmember} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{not} \PYGcolorful{o}{(}\PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e}\PYGcolorful{o}{).}\PYGcolorful{n}{deco}\PYGcolorful{o}{)}
    \PYGcolorful{k}{then} \PYGcolorful{n}{expr\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{e}
\PYGcolorful{o+ow}{and} \PYGcolorful{n}{expr\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{n}{lv} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{lv\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{lv}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}


\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{o}{?(}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{env} \PYGcolorful{n}{expr} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{n}{lv} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{lv\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{n}{env} \PYGcolorful{n}{lv} \PYGcolorful{k}{in}
    \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{n}{lv\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{t}
  \PYGcolorful{o}{|} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression should be a left value\PYGcolorfulZdq{}} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{else} \PYGcolorful{k}{begin}
      \PYGcolorful{k}{match} \PYGcolorful{n}{e} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Econst} \PYGcolorful{n}{c} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Econst} \PYGcolorful{n}{c}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}const} \PYGcolorful{n}{c}\PYGcolorful{o}{)}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Enot} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin}
          \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}not\PYGcolorfulZdq{}} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)} \PYGcolorful{o}{[}\PYGcolorful{n}{e}\PYGcolorful{o}{]} \PYGcolorful{k}{with}
            \PYGcolorful{o}{|} \PYGcolorful{o}{([}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{],} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)}
            \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
          \PYGcolorful{k}{in}
          \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Enot} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{t}
        \PYGcolorful{k}{end}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{e1}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{,} \PYGcolorful{n}{e2}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin}
          \PYGcolorful{k}{match} \PYGcolorful{n}{b} \PYGcolorful{k}{with}
          \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Beq} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bneq} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{e1\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e1} \PYGcolorful{k}{in}
            \PYGcolorful{k}{let} \PYGcolorful{n}{e2\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e2} \PYGcolorful{k}{in}
            \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e2}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
            \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e1}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
            \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{))} \PYGcolorful{k+kt}{bool}
          \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin}
              \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
                \PYGcolorful{k}{match} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}to\PYGcolorfulZus{}string} \PYGcolorful{n}{print\PYGcolorfulZus{}binop} \PYGcolorful{n}{b}\PYGcolorful{o}{)}
                                            \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)} \PYGcolorful{o}{[}\PYGcolorful{n}{e1}\PYGcolorful{o}{;} \PYGcolorful{n}{e2}\PYGcolorful{o}{]} \PYGcolorful{k}{with}
              \PYGcolorful{o}{|} \PYGcolorful{o}{([}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{;} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{],} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)}
              \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
              \PYGcolorful{k}{in}
              \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{))} \PYGcolorful{n}{t}
            \PYGcolorful{k}{end}
        \PYGcolorful{k}{end}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Enew} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{k}{in}
        \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Enew} \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{))} \PYGcolorful{o}{(}\PYGcolorful{n}{to\PYGcolorfulZus{}access} \PYGcolorful{n}{t}\PYGcolorful{o}{)}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Eapp\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{f}\PYGcolorful{o}{,} \PYGcolorful{n}{params}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} 
        \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{n}{env} \PYGcolorful{n}{f} \PYGcolorful{n}{params} \PYGcolorful{k}{in}
        \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eapp\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}ident} \PYGcolorful{n}{env} \PYGcolorful{n}{f}\PYGcolorful{o}{,} \PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{))} \PYGcolorful{n}{t}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
    \PYGcolorful{k}{end}


\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{o}{?(}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{env} \PYGcolorful{n}{lv} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{not\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{n}{loc} \PYGcolorful{o}{=} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression should be a left value\PYGcolorfulZdq{}} \PYGcolorful{n}{loc} \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{n}{lv} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Lident} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{id\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}ident} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{id\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{.}\PYGcolorful{n}{def} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{k}{then} \PYGcolorful{n}{not\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{k}{else} \PYGcolorful{n}{r}
      \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{id\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Lident} \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id\PYGcolorfulZsq{}} \PYGcolorful{n}{t}\PYGcolorful{o}{),} \PYGcolorful{n}{t}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Lmember} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{n}{f}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{begin}
      \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
      \PYGcolorful{k}{let} \PYGcolorful{n}{r} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{.}\PYGcolorful{n}{def} \PYGcolorful{k}{with}
        \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Trecord} \PYGcolorful{n}{r} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{r}
        \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Taccess} \PYGcolorful{n}{r} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}record} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{r}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
                                        \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{r} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)).}\PYGcolorful{n}{def} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
        \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression should be a record or an \PYGcolorfulZbs{}}
\PYGcolorful{l+s+s2}{                                      access on a record\PYGcolorfulZdq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{k}{in}
      \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}field} \PYGcolorful{n}{env} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{n}{r} \PYGcolorful{n}{f} \PYGcolorful{k}{in}
      \PYGcolorful{k}{if} \PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{not} \PYGcolorful{o}{(}\PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)}
      \PYGcolorful{k}{then} \PYGcolorful{n}{ignore} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{env} \PYGcolorful{n}{e}\PYGcolorful{o}{);}
      \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Lmember} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{f} \PYGcolorful{n}{t}\PYGcolorful{o}{),} \PYGcolorful{n}{t}\PYGcolorful{o}{)}
    \PYGcolorful{k}{end}


\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{o}{?(}\PYGcolorful{n}{expr} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{true}\PYGcolorful{o}{)} \PYGcolorful{n}{env} \PYGcolorful{n}{name} \PYGcolorful{n}{params} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{typ} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{name} \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{o}{(}\PYGcolorful{n}{typ}\PYGcolorful{o}{.}\PYGcolorful{n}{def}\PYGcolorful{o}{,} \PYGcolorful{n}{expr}\PYGcolorful{o}{)} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{t}\PYGcolorful{o}{),} \PYGcolorful{n+nb+bp}{true}\PYGcolorful{o}{)} \PYGcolorful{k}{when} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n}{null} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A procedure cannot be called in an expression\PYGcolorfulZdq{}} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
  \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{t}\PYGcolorful{o}{),} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{k}{when} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZlt{}\PYGcolorfulZgt{}} \PYGcolorful{n}{null} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A function cannot be applied in a statement\PYGcolorfulZdq{}} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
  \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{l}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{),} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin}
      \PYGcolorful{k}{try}
        \PYGcolorful{k}{let} \PYGcolorful{n}{params\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map2}
                        \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
                           \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{m} \PYGcolorful{k}{with}
                             \PYGcolorful{o}{|} \PYGcolorful{n+nc}{In} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e}
                             \PYGcolorful{o}{|} \PYGcolorful{n+nc}{InOut} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
                               \PYGcolorful{n}{expr\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{e}\PYGcolorful{o}{;} \PYGcolorful{n}{e\PYGcolorfulZsq{}}
                           \PYGcolorful{k}{in}
                           \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
                           \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{l} \PYGcolorful{n}{params} \PYGcolorful{k}{in}
        \PYGcolorful{o}{(}\PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{)}
      \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Invalid\PYGcolorfulZus{}argument} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{c}{(* \PYGcolorfulZdq{}List.map2\PYGcolorfulZdq{} *)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s expects \PYGcolorfulZpc{}d arguments but is given \PYGcolorfulZpc{}d here\PYGcolorfulZdq{}}
                 \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{length} \PYGcolorful{n}{l}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{length} \PYGcolorful{n}{params}\PYGcolorful{o}{))} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{end}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{fp}\PYGcolorful{o}{,} \PYGcolorful{n}{v}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{if} \PYGcolorful{n}{expr} \PYGcolorful{k}{then} \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}function\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}applied\PYGcolorfulZdq{}}\PYGcolorful{o}{)}
           \PYGcolorful{k}{else} \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}procedure\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}called\PYGcolorfulZdq{}}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is not a \PYGcolorfulZpc{}s, it cannot be \PYGcolorfulZpc{}s\PYGcolorfulZdq{}} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{fp} \PYGcolorful{n}{v}\PYGcolorful{o}{)} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}


\PYGcolorful{c}{(** Typing of statements *)}

\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{desc\PYGcolorfulZus{}type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{stmt} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{stmt}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{lv}\PYGcolorful{o}{,} \PYGcolorful{n}{e}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{lv\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{env} \PYGcolorful{n}{lv} \PYGcolorful{k}{in}
    \PYGcolorful{n}{lv\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{lv}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{lv\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Scall\PYGcolorfulZus{}proc} \PYGcolorful{o}{(}\PYGcolorful{n}{p}\PYGcolorful{o}{,} \PYGcolorful{n}{params}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{expr}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{false} \PYGcolorful{n}{env} \PYGcolorful{n}{p} \PYGcolorful{n}{params} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scall\PYGcolorfulZus{}proc} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}ident} \PYGcolorful{n}{env} \PYGcolorful{n}{p}\PYGcolorful{o}{,} \PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Sreturn} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sreturn} \PYGcolorful{n}{e\PYGcolorfulZsq{}}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Sblock} \PYGcolorful{n}{l} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sblock} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type}\PYGcolorful{o}{)} \PYGcolorful{n}{l}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Scond} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{n}{s1}\PYGcolorful{o}{,} \PYGcolorful{n}{s2}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{k+kt}{bool} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{n}{s1\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s1} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{s2\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s2} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scond} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{s1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{s2\PYGcolorfulZsq{}}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Swhile} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{n}{s}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{k+kt}{bool} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{n}{s\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Swhile} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{s\PYGcolorfulZsq{}}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Sfor} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n}{rev}\PYGcolorful{o}{,} \PYGcolorful{n}{lb}\PYGcolorful{o}{,} \PYGcolorful{n}{ub}\PYGcolorful{o}{,} \PYGcolorful{n}{s}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{id\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{k+kt}{int} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{process} \PYGcolorful{n}{b} \PYGcolorful{o}{=}
      \PYGcolorful{k}{let} \PYGcolorful{n}{b\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{b} \PYGcolorful{k}{in}
      \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{k+kt}{int} \PYGcolorful{n}{b\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{b}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
      \PYGcolorful{n}{b\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{lb\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{ub\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{o}{(}\PYGcolorful{n}{process} \PYGcolorful{n}{lb}\PYGcolorful{o}{,} \PYGcolorful{n}{process} \PYGcolorful{n}{ub}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true}
                 \PYGcolorful{o}{(\PYGcolorfulZob{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{=} \PYGcolorful{n}{id}\PYGcolorful{o}{;}
                    \PYGcolorful{n}{ta} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{typ\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}integer\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
                           \PYGcolorful{n}{is\PYGcolorfulZus{}access}  \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{n+nc}{In}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{s\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sfor} \PYGcolorful{o}{(}\PYGcolorful{n}{id\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{rev}\PYGcolorful{o}{,} \PYGcolorful{n}{lb\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{ub\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{s\PYGcolorfulZsq{}}\PYGcolorful{o}{)}

\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{stmt} \PYGcolorful{o}{=}
  \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n}{desc\PYGcolorfulZus{}type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{stmt}\PYGcolorful{o}{)} \PYGcolorful{n+nb+bp}{()}


\PYGcolorful{c}{(** Typing of declarations *)}

\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{loc} \PYGcolorful{n}{stmts} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{try\PYGcolorfulZus{}ret} \PYGcolorful{n}{l} \PYGcolorful{n}{b2} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{iter} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{loc}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{loc} \PYGcolorful{n}{b}\PYGcolorful{o}{)} \PYGcolorful{n}{l}
    \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Typing\PYGcolorfulZus{}error} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{loc\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{loc\PYGcolorfulZsq{}} \PYGcolorful{n}{b2}
  \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{n}{stmts} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Function \PYGcolorfulZpc{}s does not always end with a return\PYGcolorfulZdq{}}
                   \PYGcolorful{n}{name}\PYGcolorful{o}{)} \PYGcolorful{n}{loc}
  \PYGcolorful{o}{|} \PYGcolorful{n}{s} \PYGcolorful{o}{::} \PYGcolorful{n}{tl} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin}
      \PYGcolorful{k}{match} \PYGcolorful{n}{s}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Scall\PYGcolorfulZus{}proc} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Swhile} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Sfor} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{s}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{tl}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Sreturn} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin} \PYGcolorful{k}{match} \PYGcolorful{n}{tl} \PYGcolorful{k}{with}
          \PYGcolorful{o}{|} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}
          \PYGcolorful{o}{|} \PYGcolorful{n}{s} \PYGcolorful{o}{::} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{report} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{warning}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZdq{}} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Dead code\PYGcolorfulZdq{}} \PYGcolorful{n}{s}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
        \PYGcolorful{k}{end}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Sblock} \PYGcolorful{n}{b} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{try\PYGcolorfulZus{}ret} \PYGcolorful{o}{[(}\PYGcolorful{n}{loc}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{)]} \PYGcolorful{n}{tl}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Scond} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{s1}\PYGcolorful{o}{,} \PYGcolorful{n}{s2}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{try\PYGcolorfulZus{}ret} \PYGcolorful{o}{[(}\PYGcolorful{n}{s1}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{,} \PYGcolorful{o}{[}\PYGcolorful{n}{s1}\PYGcolorful{o}{]);} \PYGcolorful{o}{(}\PYGcolorful{n}{s2}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{,} \PYGcolorful{o}{[}\PYGcolorful{n}{s2}\PYGcolorful{o}{])]} \PYGcolorful{n}{tl}
    \PYGcolorful{k}{end}


\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{type\PYGcolorfulZus{}decl} \PYGcolorful{n}{env} \PYGcolorful{n}{d} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{id} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{deco\PYGcolorfulZus{}level} \PYGcolorful{n}{env} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{n}{d} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Dtype\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{None}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dtype\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{None}\PYGcolorful{o}{),} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Dtype\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{ta}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A type cannot be an access on itself\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{ta\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot} \PYGcolorful{n}{env} \PYGcolorful{n}{ta} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{t\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t} \PYGcolorful{k}{with} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{n}{t\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}subtypes} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{t\PYGcolorfulZsq{}} \PYGcolorful{n}{t} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dtype\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{ta\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Drecord\PYGcolorfulZus{}def} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n}{fields}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZus{}with\PYGcolorfulZus{}r} \PYGcolorful{o}{=} \PYGcolorful{k}{try}
        \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{n}{id}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Typing\PYGcolorfulZus{}error} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{env} \PYGcolorful{c}{(* r already declared *)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{idents} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{a} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{)} \PYGcolorful{n}{fields} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n+nb+bp}{()} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{find\PYGcolorfulZus{}duplicates}
                     \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{i} \PYGcolorful{n}{i\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{String}\PYGcolorful{p}{.}\PYGcolorful{n}{compare} \PYGcolorful{n}{i}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{idents} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{None} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Some} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Field \PYGcolorfulZpc{}s has already been declared\PYGcolorfulZdq{}}
                               \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{fields\PYGcolorfulZus{}t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{a} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
                              \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env\PYGcolorfulZus{}with\PYGcolorfulZus{}r} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta} \PYGcolorful{k}{in}
                              \PYGcolorful{n}{map\PYGcolorfulZus{}a} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{o}{(}\PYGcolorful{n}{get\PYGcolorfulZus{}level} \PYGcolorful{n}{t}\PYGcolorful{o}{))} \PYGcolorful{n}{a}\PYGcolorful{o}{)}
                     \PYGcolorful{n}{fields} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{fields\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{a} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{=} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{;}
                                       \PYGcolorful{n}{ta} \PYGcolorful{o}{=} \PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot} \PYGcolorful{n}{env\PYGcolorfulZus{}with\PYGcolorfulZus{}r} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZcb{})}
                    \PYGcolorful{n}{fields} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id}
                 \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{id}\PYGcolorful{o}{;}
                   \PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Trecord} \PYGcolorful{n}{fields\PYGcolorfulZus{}t} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Drecord\PYGcolorfulZus{}def} \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{,} \PYGcolorful{n}{fields\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Dvar\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{e}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{typ} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{e} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{None} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nc}{None}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
        \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{typ} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
        \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{e\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{n}{typ} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dvar\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}annotated} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{a}\PYGcolorful{o}{),} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{),}
     \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{pf} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{n}{env} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{return\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{ret}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{return} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{None} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{null}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{None}\PYGcolorful{o}{)}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{ta} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{o}{[}\PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{stmt}\PYGcolorful{o}{];}
        \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{ta}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Some} \PYGcolorful{o}{(}\PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot} \PYGcolorful{n}{env} \PYGcolorful{n}{ta}\PYGcolorful{o}{)))} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{params\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}annotated} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{))} \PYGcolorful{c}{(* ensures wf *)}
                    \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{params} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{add\PYGcolorfulZus{}pf} \PYGcolorful{n}{env2} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env2} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{level} \PYGcolorful{n}{env}\PYGcolorful{o}{)} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{name}
                        \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{;}
                          \PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func}
                                  \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{((\PYGcolorfulZus{},} \PYGcolorful{n}{t}\PYGcolorful{o}{),} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{))} \PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,}
                                   \PYGcolorful{n}{return\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{fold\PYGcolorfulZus{}left} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{env} \PYGcolorful{n}{p} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{n}{env} \PYGcolorful{n}{p}\PYGcolorful{o}{)}
                 \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{incr\PYGcolorfulZus{}level} \PYGcolorful{n}{env}\PYGcolorful{o}{)} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{params} \PYGcolorful{k}{in}
    \PYGcolorful{c}{(* Adding pf after params and return, thanks to the absurd shadowing rules *)}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{decls\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}decls} \PYGcolorful{o}{(}\PYGcolorful{n}{add\PYGcolorfulZus{}pf} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{stmt}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{decls} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{stmt\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{n}{return\PYGcolorfulZsq{}} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{stmt} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{pf\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{name} \PYGcolorful{o}{=} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n}{name} \PYGcolorful{n+nb+bp}{()}\PYGcolorful{o}{;}
                \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{params} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{((}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{}),} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{))} \PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{;}
                \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{return} \PYGcolorful{o}{=} \PYGcolorful{n}{ret}\PYGcolorful{o}{;}
                \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{decls} \PYGcolorful{o}{=} \PYGcolorful{n}{decls\PYGcolorfulZsq{}}\PYGcolorful{o}{;} \PYGcolorful{c}{(* embed environment? *)}
                \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{stmt} \PYGcolorful{o}{=} \PYGcolorful{n}{stmt\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{pf\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{add\PYGcolorfulZus{}pf} \PYGcolorful{n}{env}\PYGcolorful{o}{)}

\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}decls} \PYGcolorful{n}{env} \PYGcolorful{n}{loc\PYGcolorfulZus{}after} \PYGcolorful{n}{decls} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{decls} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{n}{env} \PYGcolorful{n}{loc\PYGcolorfulZus{}after}\PYGcolorful{o}{;} \PYGcolorful{o}{(}\PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n}{d} \PYGcolorful{o}{::} \PYGcolorful{n}{ds} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{d\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}decl} \PYGcolorful{n}{env} \PYGcolorful{n}{d} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{ds\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}decls} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{loc\PYGcolorfulZus{}after} \PYGcolorful{n}{ds} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n}{d\PYGcolorfulZsq{}} \PYGcolorful{o}{::} \PYGcolorful{n}{ds\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}}\PYGcolorful{o}{)}


\PYGcolorful{c}{(** Typing of a program *)}

\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}ast} \PYGcolorful{o}{(}\PYGcolorful{n}{a} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ast}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}decl} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{new\PYGcolorfulZus{}env} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{a}\PYGcolorful{o}{))} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{a\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{a\PYGcolorfulZsq{}} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{ast}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
\end{Verbatim}

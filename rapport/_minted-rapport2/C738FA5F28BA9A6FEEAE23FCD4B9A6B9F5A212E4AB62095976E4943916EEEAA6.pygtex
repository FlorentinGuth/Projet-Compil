\begin{Verbatim}[commandchars=\\\{\}]
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Ast\PYGcolorfulZus{}common}
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Utils}
\PYGcolorful{k}{open} \PYGcolorful{n+nc}{Printer}

\PYGcolorful{k}{module} \PYGcolorful{n+nc}{A} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Ast}
\PYGcolorful{k}{module} \PYGcolorful{n+nc}{T} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Ast\PYGcolorfulZus{}typed}


\PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}unique\PYGcolorfulZus{}id}  \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{n} \PYGcolorful{o}{=} \PYGcolorful{n}{ref} \PYGcolorful{o}{(\PYGcolorfulZhy{}}\PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
  \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{incr} \PYGcolorful{n}{n}\PYGcolorful{o}{;} \PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZus{}\PYGcolorfulZpc{}s\PYGcolorfulZus{}\PYGcolorfulZpc{}d\PYGcolorfulZdq{}} \PYGcolorful{n}{id} \PYGcolorful{o}{!}\PYGcolorful{n}{n}\PYGcolorful{o}{)}

\PYGcolorful{c}{(** General error functions *)}

\PYGcolorful{k}{let} \PYGcolorful{n}{error} \PYGcolorful{n}{msg} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
  \PYGcolorful{k}{raise} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Typing\PYGcolorfulZus{}error} \PYGcolorful{o}{(}\PYGcolorful{n}{msg}\PYGcolorful{o}{,} \PYGcolorful{n}{loc}\PYGcolorful{o}{))}


\PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}record} \PYGcolorful{n}{typ} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{typ} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Trecord} \PYGcolorful{n}{r} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{r}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A record was expected\PYGcolorfulZdq{}} \PYGcolorful{n}{loc}

\PYGcolorful{k}{let} \PYGcolorful{n}{wrong\PYGcolorfulZus{}type} \PYGcolorful{n}{t\PYGcolorfulZus{}exp} \PYGcolorful{n}{t\PYGcolorfulZus{}proc} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{print\PYGcolorfulZus{}typ\PYGcolorfulZus{}to\PYGcolorfulZus{}str} \PYGcolorful{o}{=} \PYGcolorful{n}{print\PYGcolorfulZus{}to\PYGcolorfulZus{}string} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{print\PYGcolorfulZus{}typ} \PYGcolorful{k}{in}
  \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf}
           \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression has type \PYGcolorfulZpc{}s but was expected of type \PYGcolorfulZpc{}s\PYGcolorfulZdq{}}
           \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}typ\PYGcolorfulZus{}to\PYGcolorfulZus{}str} \PYGcolorful{n}{t\PYGcolorfulZus{}proc}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}typ\PYGcolorfulZus{}to\PYGcolorfulZus{}str} \PYGcolorful{n}{t\PYGcolorfulZus{}exp}\PYGcolorful{o}{))} \PYGcolorful{n}{loc}


\PYGcolorful{c}{(** The environment module *)}

\PYGcolorful{k}{module} \PYGcolorful{n+nc}{Env} \PYGcolorful{o}{:} \PYGcolorful{k}{sig}
  \PYGcolorful{k}{type} \PYGcolorful{n}{t}

  \PYGcolorful{k}{val} \PYGcolorful{n}{new\PYGcolorfulZus{}env} \PYGcolorful{o}{:} \PYGcolorful{n}{t}
  \PYGcolorful{c}{(** Returns a new environment with builtins *)}

  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{int} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{ident} \PYGcolorful{o}{*} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ}
  \PYGcolorful{c}{(** Types an identifier (variable or procedure/function) at a given level }
\PYGcolorful{c}{      (default is current one) *)}
  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{int} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident\PYGcolorfulZus{}decl} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ}
  \PYGcolorful{c}{(** Types a typ\PYGcolorfulZus{}ident, i.e. a name of a type *)}
  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{int} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}annot} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ}
  \PYGcolorful{c}{(** Takes into account whether typ\PYGcolorfulZus{}annot is an access or not *)}

  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{int} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{bool} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{mode}\PYGcolorful{o}{:}\PYGcolorful{n}{mode} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t} \PYGcolorful{o}{*} \PYGcolorful{k+kt}{int}
  \PYGcolorful{c}{(** Sets the type of an identifier (variable or procedure/function), at the given}
\PYGcolorful{c}{      level, and force (defaults to false) prevents the env to check for multiple }
\PYGcolorful{c}{      definitions of the same variable (useful for for\PYGcolorfulZhy{}loop\PYGcolorfulZhy{}counter\PYGcolorfulZhy{}variables).}
\PYGcolorful{c}{      It also returns the offset of the newly declared variable *)}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{bool} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{bool} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{param} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t} \PYGcolorful{o}{*} \PYGcolorful{k+kt}{int}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{?}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{k+kt}{bool} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}subtypes} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{c}{(* big *)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{c}{(* little *)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{set\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}

  \PYGcolorful{k}{val} \PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{loc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{unit}
  \PYGcolorful{k}{val} \PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{unit}
  \PYGcolorful{k}{val} \PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{loc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{unit}

  \PYGcolorful{k}{val} \PYGcolorful{n}{register\PYGcolorfulZus{}pf} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}pf\PYGcolorfulZus{}id} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc}

  \PYGcolorful{k}{val} \PYGcolorful{n}{level} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{int}
  \PYGcolorful{k}{val} \PYGcolorful{n}{incr\PYGcolorfulZus{}level} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
  \PYGcolorful{k}{val} \PYGcolorful{n}{deco\PYGcolorfulZus{}level} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident}
  \PYGcolorful{c}{(** Decorates the given identifier with the current level *)}
  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}frame\PYGcolorfulZus{}size} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{int}
  \PYGcolorful{k}{val} \PYGcolorful{n}{get\PYGcolorfulZus{}ret\PYGcolorfulZus{}ofs} \PYGcolorful{o}{:} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k+kt}{int}
\PYGcolorful{k}{end} \PYGcolorful{o}{=} \PYGcolorful{k}{struct}
  \PYGcolorful{k}{type} \PYGcolorful{n}{constr} \PYGcolorful{o}{=}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Ta} \PYGcolorful{c}{(* type\PYGcolorfulZus{}annot *)}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Id} \PYGcolorful{c}{(* variable or procedure/fonction *)}
  \PYGcolorful{k}{type} \PYGcolorful{n}{obj} \PYGcolorful{o}{=} \PYGcolorful{n}{constr} \PYGcolorful{o}{*} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{o}{*} \PYGcolorful{k+kt}{int}\PYGcolorful{o}{)}

  \PYGcolorful{k}{module} \PYGcolorful{n+nc}{Tset} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Set}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Make}\PYGcolorful{o}{(}\PYGcolorful{k}{struct} \PYGcolorful{k}{type} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ} \PYGcolorful{o}{*} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{typ}
      \PYGcolorful{k}{let} \PYGcolorful{n}{compare} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Pervasives}\PYGcolorful{p}{.}\PYGcolorful{n}{compare} \PYGcolorful{k}{end}\PYGcolorful{o}{)}

  \PYGcolorful{k}{type} \PYGcolorful{n}{map} \PYGcolorful{o}{=} \PYGcolorful{o}{(}\PYGcolorful{n}{obj} \PYGcolorful{o}{*} \PYGcolorful{k+kt}{int}\PYGcolorful{o}{)} \PYGcolorful{k+kt}{list} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{t}
  \PYGcolorful{k}{type} \PYGcolorful{n}{t} \PYGcolorful{o}{=} 
    \PYGcolorful{o}{\PYGcolorfulZob{}}
      \PYGcolorful{n}{objs}    \PYGcolorful{o}{:} \PYGcolorful{n}{map}\PYGcolorful{o}{;}    \PYGcolorful{c}{(* Maps an identifier to its type *)}
      \PYGcolorful{n}{consts}  \PYGcolorful{o}{:} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;} \PYGcolorful{c}{(* Set of variables that shouldn\PYGcolorfulZsq{}t be modified *)}
      \PYGcolorful{n}{notdef}  \PYGcolorful{o}{:} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;} \PYGcolorful{c}{(* Set of types that haven\PYGcolorfulZsq{}t been defined yet *)}
      \PYGcolorful{n}{byref}   \PYGcolorful{o}{:} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;} \PYGcolorful{c}{(* Set of variables that have been passed by reference *)}
      \PYGcolorful{n}{subtypes}\PYGcolorful{o}{:} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;} \PYGcolorful{c}{(* Contains (t1, t2) pairs where t2 is a subtype of t1 *)}
      \PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{:} \PYGcolorful{k+kt}{int}\PYGcolorful{o}{;}
      \PYGcolorful{n}{offset\PYGcolorfulZus{}params}\PYGcolorful{o}{:} \PYGcolorful{k+kt}{int}\PYGcolorful{o}{;}
      \PYGcolorful{n}{offset\PYGcolorfulZus{}vars}\PYGcolorful{o}{:}   \PYGcolorful{k+kt}{int}\PYGcolorful{o}{;}
      \PYGcolorful{n}{unique\PYGcolorfulZus{}ids}\PYGcolorful{o}{:} \PYGcolorful{o}{(}\PYGcolorful{n}{ident\PYGcolorfulZus{}desc} \PYGcolorful{o}{*} \PYGcolorful{k+kt}{int}\PYGcolorful{o}{)} \PYGcolorful{k+kt}{list} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{t}\PYGcolorful{o}{;}
    \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{c}{(* Functions to perform checks on objects, when they are expected to be an ident}
\PYGcolorful{c}{     and they are in fact a type for instance *)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{to\PYGcolorfulZus{}id} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{o}{((}\PYGcolorful{n+nc}{Id}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{to\PYGcolorfulZus{}ta} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{o}{((}\PYGcolorful{n+nc}{Ta}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{of\PYGcolorfulZus{}id} \PYGcolorful{o}{(}\PYGcolorful{n}{obj} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{match} \PYGcolorful{n}{obj} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Id}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Ta}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is a type but an identifier is expected\PYGcolorfulZdq{}}
                          \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
  \PYGcolorful{k}{let} \PYGcolorful{n}{of\PYGcolorfulZus{}ta} \PYGcolorful{o}{(}\PYGcolorful{n}{obj} \PYGcolorful{o}{:} \PYGcolorful{n}{obj}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{match} \PYGcolorful{n}{obj} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Id}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is an identifier but a type is expected\PYGcolorfulZdq{}}
                          \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Ta}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t}


  \PYGcolorful{k}{let} \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{(}\PYGcolorful{n}{ts}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{In}\PYGcolorful{o}{))} \PYGcolorful{n}{ts}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{reserved} \PYGcolorful{o}{=} \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}character\PYGcolorfulZsq{}val\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{([}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}\PYGcolorful{o}{],}  \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{char}\PYGcolorful{o}{));}
                  \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}put\PYGcolorfulZdq{}}\PYGcolorful{o}{,}           \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{([}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{char}\PYGcolorful{o}{],} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{null}\PYGcolorful{o}{));}
                  \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}new\PYGcolorfulZus{}line\PYGcolorfulZdq{}}\PYGcolorful{o}{,}      \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{(}\PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{,}       \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{null}\PYGcolorful{o}{));}
                 \PYGcolorful{o}{]}

  \PYGcolorful{k}{let} \PYGcolorful{n}{unops}    \PYGcolorful{o}{=} \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}not\PYGcolorfulZdq{}}\PYGcolorful{o}{,}           \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{([}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}\PYGcolorful{o}{],} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}\PYGcolorful{o}{))]} 

  \PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}binop} \PYGcolorful{o}{=} \PYGcolorful{k}{function}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Beq} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bneq} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}                            \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Blt} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bleq} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bgt} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bgeq} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}               \PYGcolorful{o}{([}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}\PYGcolorful{o}{;}  \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}\PYGcolorful{o}{],}  \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}\PYGcolorful{o}{)}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bplus} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bminus} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Btimes} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bdiv} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Brem} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{([}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}\PYGcolorful{o}{;}  \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}\PYGcolorful{o}{],}  \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}\PYGcolorful{o}{)}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Band} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Band\PYGcolorfulZus{}then} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bor} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bor\PYGcolorfulZus{}else} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}     \PYGcolorful{o}{([}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}\PYGcolorful{o}{;} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}\PYGcolorful{o}{],} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}\PYGcolorful{o}{)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{binops} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{b} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}to\PYGcolorfulZus{}string} \PYGcolorful{n}{print\PYGcolorfulZus{}binop} \PYGcolorful{n}{b}\PYGcolorful{o}{,}
                                   \PYGcolorful{n}{add\PYGcolorfulZus{}in} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}binop} \PYGcolorful{n}{b}\PYGcolorful{o}{)))}
                 \PYGcolorful{o}{[}\PYGcolorful{n+nc}{Blt}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bleq}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bgt}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bgeq}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bplus}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bminus}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Btimes}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bdiv}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Brem}\PYGcolorful{o}{;}
                  \PYGcolorful{n+nc}{Band}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Band\PYGcolorfulZus{}then}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bor}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Bor\PYGcolorfulZus{}else}\PYGcolorful{o}{]}

  \PYGcolorful{k}{let} \PYGcolorful{n}{formate} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{k}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{k}\PYGcolorful{o}{,} \PYGcolorful{o}{[(}\PYGcolorful{n}{to\PYGcolorfulZus{}id} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{n}{k} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{;}
                                                         \PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n}{t}\PYGcolorful{o}{;}
                                                         \PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZhy{}}\PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{;} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{),} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)]))}
  \PYGcolorful{k}{let} \PYGcolorful{n}{builtins\PYGcolorfulZus{}ids} \PYGcolorful{o}{=} \PYGcolorful{n}{formate} \PYGcolorful{o}{(}\PYGcolorful{n}{reserved} \PYGcolorful{o}{@} \PYGcolorful{n}{unops} \PYGcolorful{o}{@} \PYGcolorful{n}{binops}\PYGcolorful{o}{)}

  \PYGcolorful{k}{let} \PYGcolorful{n}{primitives} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{,} \PYGcolorful{o}{[(}\PYGcolorful{n}{to\PYGcolorfulZus{}ta} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{),} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)]))}
                     \PYGcolorful{o}{[}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{null}\PYGcolorful{o}{;} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}\PYGcolorful{o}{;} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{char}\PYGcolorful{o}{;} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}\PYGcolorful{o}{]}

  \PYGcolorful{k}{let} \PYGcolorful{n}{new\PYGcolorfulZus{}env} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{objs} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{of\PYGcolorfulZus{}list} \PYGcolorful{o}{(}\PYGcolorful{n}{builtins\PYGcolorfulZus{}ids} \PYGcolorful{o}{@} \PYGcolorful{n}{primitives}\PYGcolorful{o}{);}
                  \PYGcolorful{n}{consts} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{empty}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{empty}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{byref}  \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{empty}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{subtypes} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{empty}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{;} \PYGcolorful{c}{(* TODO change? *)}
                  \PYGcolorful{n}{offset\PYGcolorfulZus{}params} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{3}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{offset\PYGcolorfulZus{}vars}   \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{unique\PYGcolorfulZus{}ids} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{of\PYGcolorfulZus{}list}
                                 \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}new\PYGcolorfulZus{}line\PYGcolorfulZdq{}}\PYGcolorful{o}{,}      \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}new\PYGcolorfulZus{}line\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)]);}
                                  \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}put\PYGcolorfulZdq{}}\PYGcolorful{o}{,}           \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}put\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)]);}
                                  \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}character\PYGcolorfulZsq{}val\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{o}{[(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}character\PYGcolorfulZsq{}val\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)]);}
                                 \PYGcolorful{o}{]}
                \PYGcolorful{o}{\PYGcolorfulZcb{}}


  \PYGcolorful{c}{(* Helper function to avoid copypasting get\PYGcolorfulZus{}id\PYGcolorfulZus{}type into get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type *)}
  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{lvl} \PYGcolorful{n}{id} \PYGcolorful{n}{id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{n}{of\PYGcolorfulZus{}id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Unknown \PYGcolorfulZpc{}s: \PYGcolorfulZpc{}s\PYGcolorfulZdq{}} \PYGcolorful{n}{id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
                          \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{o}\PYGcolorful{o}{,} \PYGcolorful{n}{lvl\PYGcolorfulZus{}o}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{snd} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZlt{}=} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{n}{l} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n}{of\PYGcolorfulZus{}id\PYGcolorfulZus{}or\PYGcolorfulZus{}ta} \PYGcolorful{n}{o} \PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n}{lvl\PYGcolorfulZus{}o}\PYGcolorful{o}{)}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A variable cannot depend on its own initialization\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{else} \PYGcolorful{k}{let} \PYGcolorful{o}{((}\PYGcolorful{n}{typ}\PYGcolorful{o}{,} \PYGcolorful{n}{offset}\PYGcolorful{o}{),} \PYGcolorful{n}{level}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{get\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{lvl} \PYGcolorful{n}{id} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}identifier\PYGcolorfulZdq{}} \PYGcolorful{n}{of\PYGcolorfulZus{}id} \PYGcolorful{k}{in}
      \PYGcolorful{k}{let} \PYGcolorful{n}{byref} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{byref} \PYGcolorful{k}{in}
      \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{is\PYGcolorfulZus{}reference} \PYGcolorful{o}{=} \PYGcolorful{n}{byref}\PYGcolorful{o}{;}
           \PYGcolorful{n}{size} \PYGcolorful{o}{=} \PYGcolorful{n}{typ}\PYGcolorful{o}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size}\PYGcolorful{o}{;}
           \PYGcolorful{n}{level} \PYGcolorful{o}{=} \PYGcolorful{n}{lvl} \PYGcolorful{o}{\PYGcolorfulZhy{}} \PYGcolorful{n}{level}\PYGcolorful{o}{;}
           \PYGcolorful{n}{offset} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{n}{typ}\PYGcolorful{o}{)}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{n}{ti} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{o}{((}\PYGcolorful{n}{typ}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{}}\PYGcolorful{n}{offset}\PYGcolorful{o}{),} \PYGcolorful{o}{\PYGcolorfulZus{}}\PYGcolorful{n}{level}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{get\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{lvl} \PYGcolorful{n}{ti} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}defined type\PYGcolorfulZdq{}} \PYGcolorful{n}{of\PYGcolorfulZus{}ta} \PYGcolorful{k}{in}
    \PYGcolorful{n}{typ}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{n}{ta} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{k}{then}
      \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{k}{then}
        \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZdq{}} \PYGcolorful{n}{lvl}\PYGcolorful{o}{;}
          \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Taccess} \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident} \PYGcolorful{n}{lvl}\PYGcolorful{o}{);}
          \PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{;} \PYGcolorful{o}{\PYGcolorfulZcb{}}
      \PYGcolorful{k}{else} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{to\PYGcolorfulZus{}access} \PYGcolorful{o}{(}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{)}
    \PYGcolorful{k}{else} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}


  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{lvl} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{o}{?(}\PYGcolorful{n}{force} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{o}{?}\PYGcolorful{n}{mode} \PYGcolorful{n}{id} \PYGcolorful{n}{typ} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs} \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{lvl\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n}{snd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{snd} \PYGcolorful{n}{o} \PYGcolorful{o}{\PYGcolorfulZlt{}=} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{n}{l}\PYGcolorful{o}{)}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{\PYGcolorfulZhy{}}\PYGcolorful{l+m+mi}{1} \PYGcolorful{k}{in}
    \PYGcolorful{k}{if} \PYGcolorful{n}{lvl\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{lvl} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{not} \PYGcolorful{n}{force}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already defined at this level\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{offs}\PYGcolorful{o}{,} \PYGcolorful{n}{new\PYGcolorfulZus{}ofs\PYGcolorfulZus{}vars}\PYGcolorful{o}{,} \PYGcolorful{n}{new\PYGcolorfulZus{}ofs\PYGcolorfulZus{}p}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{o}{(}\PYGcolorful{n}{mode}\PYGcolorful{o}{,} \PYGcolorful{n}{force}\PYGcolorful{o}{)} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Some} \PYGcolorful{n+nc}{In}\PYGcolorful{o}{,} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}params}\PYGcolorful{o}{,}
                             \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}vars}\PYGcolorful{o}{,}
                             \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}params} \PYGcolorful{o}{+} \PYGcolorful{n}{typ}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size}\PYGcolorful{o}{)}
      \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Some} \PYGcolorful{n+nc}{InOut}\PYGcolorful{o}{,} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}params}\PYGcolorful{o}{,}
                                \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}vars}\PYGcolorful{o}{,}
                                \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}params} \PYGcolorful{o}{+} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{)}
      \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{ofs\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}vars} \PYGcolorful{o}{\PYGcolorfulZhy{}} \PYGcolorful{n}{typ}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{k}{in}
        \PYGcolorful{o}{(}\PYGcolorful{n}{ofs\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{ofs\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}params}\PYGcolorful{o}{)}
    \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{o}{(}\PYGcolorful{n}{to\PYGcolorfulZus{}id} \PYGcolorful{o}{(}\PYGcolorful{n}{typ}\PYGcolorful{o}{,} \PYGcolorful{n}{offs}\PYGcolorful{o}{),} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{o}{::} \PYGcolorful{n}{l} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{stable\PYGcolorfulZus{}sort} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{n}{o\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{compare} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o}\PYGcolorful{o}{))} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{objs} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}\PYGcolorful{o}{;}
                \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{remove} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef}\PYGcolorful{o}{;}
                \PYGcolorful{n}{offset\PYGcolorfulZus{}vars} \PYGcolorful{o}{=} \PYGcolorful{n}{new\PYGcolorfulZus{}ofs\PYGcolorfulZus{}vars}\PYGcolorful{o}{;}
                \PYGcolorful{n}{offset\PYGcolorfulZus{}params} \PYGcolorful{o}{=} \PYGcolorful{n}{new\PYGcolorfulZus{}ofs\PYGcolorfulZus{}p} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{n}{offs}\PYGcolorful{o}{)}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{force} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{ta} \PYGcolorful{n}{typ} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs} \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n+nb+bp}{()} \PYGcolorful{o}{=} \PYGcolorful{k}{try}
        \PYGcolorful{k}{if} \PYGcolorful{n}{snd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{hd} \PYGcolorful{n}{l}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{not} \PYGcolorful{n}{force}
        \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already defined at this level\PYGcolorfulZdq{}}
                      \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Failure} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{c}{(*\PYGcolorfulZdq{}hd\PYGcolorfulZdq{}*)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{o}{(}\PYGcolorful{n}{to\PYGcolorfulZus{}ta} \PYGcolorful{o}{(}\PYGcolorful{n}{typ}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{),} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{o}{::} \PYGcolorful{n}{l} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{stable\PYGcolorfulZus{}sort} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{n}{o\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{compare} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o}\PYGcolorful{o}{))} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{objs} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{l\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}\PYGcolorful{o}{;}
               \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{remove} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{n}{env} \PYGcolorful{o}{?}\PYGcolorful{n}{force} \PYGcolorful{o}{(}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{env}\PYGcolorful{o}{,} \PYGcolorful{n}{ofs}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{?}\PYGcolorful{n}{force} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{mode}\PYGcolorful{o}{:}\PYGcolorful{n}{m} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{n}{t} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{consts\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{byref\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{m} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{InOut} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts}\PYGcolorful{o}{,} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{byref}\PYGcolorful{o}{)}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{In}    \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{byref}\PYGcolorful{o}{)}
    \PYGcolorful{k}{in}
    \PYGcolorful{o}{(\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{consts} \PYGcolorful{o}{=} \PYGcolorful{n}{consts\PYGcolorfulZsq{}}\PYGcolorful{o}{;} \PYGcolorful{n}{byref} \PYGcolorful{o}{=} \PYGcolorful{n}{byref\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{n}{ofs}\PYGcolorful{o}{)}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{consts} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{remove} \PYGcolorful{n}{id} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}subtypes} \PYGcolorful{n}{env} \PYGcolorful{n}{t1} \PYGcolorful{n}{t2} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{sub} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{fold} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{t3}\PYGcolorful{o}{,} \PYGcolorful{n}{t4}\PYGcolorful{o}{)} \PYGcolorful{n}{tset} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{t2} \PYGcolorful{o}{=} \PYGcolorful{n}{t3} \PYGcolorful{k}{then} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{,} \PYGcolorful{n}{t4}\PYGcolorful{o}{)} \PYGcolorful{n}{tset}
                          \PYGcolorful{k}{else} \PYGcolorful{k}{if} \PYGcolorful{n}{t1} \PYGcolorful{o}{=} \PYGcolorful{n}{t4} \PYGcolorful{k}{then} \PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{o}{(}\PYGcolorful{n}{t3}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{)} \PYGcolorful{n}{tset} \PYGcolorful{k}{else} \PYGcolorful{n}{tset}\PYGcolorful{o}{)}
                \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{subtypes} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{)} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{subtypes}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{subtypes} \PYGcolorful{o}{=} \PYGcolorful{n}{sub} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{o}{?(}\PYGcolorful{n}{force} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{not} \PYGcolorful{n}{force} \PYGcolorful{k}{then}
      \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already declared at this level\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{try}
      \PYGcolorful{k}{if} \PYGcolorful{n}{snd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{hd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{objs}\PYGcolorful{o}{))} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{not} \PYGcolorful{n}{force}
      \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is already defined at this level\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
             \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{k}{else} \PYGcolorful{k}{raise} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found}
    \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{notdef} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{o}{\PYGcolorfulZcb{}}


  \PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{n}{env} \PYGcolorful{n}{loc} \PYGcolorful{o}{=}
    \PYGcolorful{k}{try}
      \PYGcolorful{k}{let} \PYGcolorful{n}{id} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{choose} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{notdef} \PYGcolorful{k}{in}
      \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s has not been defined before the \PYGcolorfulZbs{}}
\PYGcolorful{l+s+s2}{                             next level of declarations\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{)} \PYGcolorful{n}{loc}
    \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}

  \PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{k}{if} \PYGcolorful{n+nn}{Sset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{consts}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s cannot be modified, it has been \PYGcolorfulZbs{}}
\PYGcolorful{l+s+s2}{                                declared In or is a counter variable\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
           \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}

  \PYGcolorful{k}{let} \PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t1} \PYGcolorful{n}{t2} \PYGcolorful{n}{loc2} \PYGcolorful{o}{=}
    \PYGcolorful{c}{(* t2 is a subtype of t1? *)}
    \PYGcolorful{k}{match} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def}\PYGcolorful{o}{)} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Taccess} \PYGcolorful{o}{\PYGcolorfulZus{},} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Tnull}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}
    \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{not} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Tset}\PYGcolorful{p}{.}\PYGcolorful{n}{mem} \PYGcolorful{o}{(}\PYGcolorful{n}{t1}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{)} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{subtypes}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZam{}\PYGcolorfulZam{}} \PYGcolorful{n}{t1} \PYGcolorful{o}{\PYGcolorfulZlt{}\PYGcolorfulZgt{}} \PYGcolorful{n}{t2}
      \PYGcolorful{k}{then} \PYGcolorful{n}{wrong\PYGcolorfulZus{}type} \PYGcolorful{n}{t1} \PYGcolorful{n}{t2} \PYGcolorful{n}{loc2}


  \PYGcolorful{k}{let} \PYGcolorful{n}{register\PYGcolorfulZus{}pf} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{n}{id\PYGcolorfulZsq{}} \PYGcolorful{o}{=}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{unique\PYGcolorfulZus{}ids} \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Not\PYGcolorfulZus{}found} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{stable\PYGcolorfulZus{}sort} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{o} \PYGcolorful{n}{o\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{compare} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{n}{o}\PYGcolorful{o}{))}
               \PYGcolorful{o}{((}\PYGcolorful{n}{id\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}\PYGcolorful{o}{)} \PYGcolorful{o}{::} \PYGcolorful{n}{l}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{unique\PYGcolorfulZus{}ids} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{add} \PYGcolorful{n}{id} \PYGcolorful{n}{l\PYGcolorfulZsq{}} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{unique\PYGcolorfulZus{}ids} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}pf\PYGcolorfulZus{}id} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
    \PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{hd} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Smap}\PYGcolorful{p}{.}\PYGcolorful{n}{find} \PYGcolorful{n}{id} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{unique\PYGcolorfulZus{}ids}\PYGcolorful{o}{))}


  \PYGcolorful{k}{let} \PYGcolorful{n}{level} \PYGcolorful{n}{env} \PYGcolorful{o}{=}
    \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}

  \PYGcolorful{k}{let} \PYGcolorful{n}{incr\PYGcolorfulZus{}level} \PYGcolorful{n}{env} \PYGcolorful{o}{=}
    \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{env} \PYGcolorful{k}{with} \PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{=} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level} \PYGcolorful{o}{+} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{;}
               \PYGcolorful{n}{offset\PYGcolorfulZus{}vars} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{;}
               \PYGcolorful{n}{offset\PYGcolorfulZus{}params} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{3} \PYGcolorful{o}{\PYGcolorfulZcb{}}

  \PYGcolorful{k}{let} \PYGcolorful{n}{deco\PYGcolorfulZus{}level} \PYGcolorful{n}{env} \PYGcolorful{n}{s} \PYGcolorful{o}{=}
    \PYGcolorful{n}{decorate} \PYGcolorful{n}{s} \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{current\PYGcolorfulZus{}level}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}frame\PYGcolorfulZus{}size} \PYGcolorful{n}{env} \PYGcolorful{o}{=}
    \PYGcolorful{o}{\PYGcolorfulZhy{}}\PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}vars}

  \PYGcolorful{k}{let} \PYGcolorful{n}{get\PYGcolorfulZus{}ret\PYGcolorfulZus{}ofs} \PYGcolorful{n}{env} \PYGcolorful{o}{=}
    \PYGcolorful{n}{env}\PYGcolorful{o}{.}\PYGcolorful{n}{offset\PYGcolorfulZus{}params}
\PYGcolorful{k}{end}


\PYGcolorful{k}{let} \PYGcolorful{n}{deref} \PYGcolorful{n}{env} \PYGcolorful{n}{loc} \PYGcolorful{n}{t} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Taccess} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
                              \PYGcolorful{o}{(}\PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{n}{loc}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n+nb+bp}{true}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)}


\PYGcolorful{c}{(** Typing of expressions *)}

\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}const} \PYGcolorful{n}{loc} \PYGcolorful{o}{=} \PYGcolorful{k}{function}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cint}  \PYGcolorful{n}{n} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{n} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{1} \PYGcolorful{o+ow}{lsl} \PYGcolorful{l+m+mi}{31} \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Integer too big\PYGcolorfulZdq{}} \PYGcolorful{n}{loc} \PYGcolorful{k}{else} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cchar} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{char}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cbool} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Cnull}   \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{null}

\PYGcolorful{c}{(** Checks if fields has a f field, id being the name of the record, and in this}
\PYGcolorful{c}{    case return (typ\PYGcolorfulZus{}of\PYGcolorfulZus{}field, offset) *)}
\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}field} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{n}{fields} \PYGcolorful{o}{(}\PYGcolorful{n}{f} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident\PYGcolorfulZus{}decl}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}field\PYGcolorfulZus{}aux} \PYGcolorful{n}{a} \PYGcolorful{o}{=}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:}\PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{o}{(}\PYGcolorful{n}{map\PYGcolorfulZus{}ta} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta}\PYGcolorful{o}{)}
  \PYGcolorful{k}{in}
  \PYGcolorful{k}{if} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}all\PYGcolorfulZdq{}} \PYGcolorful{k}{then}
    \PYGcolorful{k}{let} \PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{fold\PYGcolorfulZus{}left} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{s} \PYGcolorful{n}{a} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{s} \PYGcolorful{o}{+} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}field\PYGcolorfulZus{}aux} \PYGcolorful{n}{a}\PYGcolorful{o}{).}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size}\PYGcolorful{o}{)}
                   \PYGcolorful{l+m+mi}{0} \PYGcolorful{n}{fields} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{id}\PYGcolorful{o}{;}
         \PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Trecord} \PYGcolorful{n}{fields}\PYGcolorful{o}{;}
         \PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)}
  \PYGcolorful{k}{else}
    \PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{search} \PYGcolorful{n}{fields} \PYGcolorful{n}{offs} \PYGcolorful{o}{=}
      \PYGcolorful{k}{match} \PYGcolorful{n}{fields} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Record \PYGcolorfulZpc{}s has no field \PYGcolorfulZpc{}s\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
                \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{o}{|} \PYGcolorful{n}{a} \PYGcolorful{o}{::} \PYGcolorful{n}{tl} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}field\PYGcolorfulZus{}aux} \PYGcolorful{n}{a} \PYGcolorful{k}{in}
        \PYGcolorful{k}{if} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{then} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n}{offs}\PYGcolorful{o}{)}
        \PYGcolorful{k}{else} \PYGcolorful{n}{search} \PYGcolorful{n}{tl} \PYGcolorful{o}{(}\PYGcolorful{n}{offs} \PYGcolorful{o}{+} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size}\PYGcolorful{o}{)}
    \PYGcolorful{k}{in}
    \PYGcolorful{n}{search} \PYGcolorful{n}{fields} \PYGcolorful{l+m+mi}{0}


\PYGcolorful{k}{let} \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{n}{e} \PYGcolorful{n}{t} \PYGcolorful{o}{=}
  \PYGcolorful{o}{((}\PYGcolorful{n}{decorate} \PYGcolorful{n}{e} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{expr}\PYGcolorful{o}{),} \PYGcolorful{n}{t}\PYGcolorful{o}{)}

\PYGcolorful{k}{exception} \PYGcolorful{n+nc}{Function} \PYGcolorful{k}{of} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ident}
\PYGcolorful{k}{exception} \PYGcolorful{n+nc}{Deref}

\PYGcolorful{c}{(** Mutually recursive functions getting to the leftmost ident to verify he shouldn\PYGcolorfulZsq{}t}
\PYGcolorful{c}{    be modified *)}
\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{lv\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{lv} \PYGcolorful{o}{=}
  \PYGcolorful{c}{(* Could probably be factorized with type\PYGcolorfulZus{}left\PYGcolorfulZus{}val, but would be less readable *)}
  \PYGcolorful{k}{match} \PYGcolorful{n}{lv} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Lident} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env} \PYGcolorful{n}{id}\PYGcolorful{o}{;}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Lmember} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{not} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{is\PYGcolorfulZus{}access} \PYGcolorful{o}{(}\PYGcolorful{n}{snd} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e}\PYGcolorful{o}{)))} \PYGcolorful{c}{(* ineffecicient *)}
    \PYGcolorful{k}{then} \PYGcolorful{n}{expr\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{e}
\PYGcolorful{o+ow}{and} \PYGcolorful{n}{expr\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{n}{lv} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{lv\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{lv}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}


\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{o}{?(}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{o}{?(}\PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}new} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{env} \PYGcolorful{n}{expr} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{n}{lv} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{n}{type\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{n}{env} \PYGcolorful{n}{lv}

  \PYGcolorful{o}{|} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{if} \PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression should be a left value\PYGcolorfulZdq{}} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{else} \PYGcolorful{k}{begin}
      \PYGcolorful{k}{match} \PYGcolorful{n}{e} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Econst} \PYGcolorful{n}{c} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}const} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{c} \PYGcolorful{k}{in} \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Econst} \PYGcolorful{n}{c}\PYGcolorful{o}{)} \PYGcolorful{n}{t}

      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Enot} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{k}{begin}
          \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}not\PYGcolorfulZdq{}} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)} \PYGcolorful{o}{[}\PYGcolorful{n}{e}\PYGcolorful{o}{]} \PYGcolorful{k}{with}
            \PYGcolorful{o}{|} \PYGcolorful{o}{([}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{],} \PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{},} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)}
            \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
          \PYGcolorful{k}{in} \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Enot} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{t}
        \PYGcolorful{k}{end}

      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{e1}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{,} \PYGcolorful{n}{e2}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{k}{begin}
          \PYGcolorful{k}{match} \PYGcolorful{n}{b} \PYGcolorful{k}{with}
          \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Beq} \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Bneq} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
            \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t1}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e1} \PYGcolorful{k}{in}
            \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t2}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e2} \PYGcolorful{k}{in}
            \PYGcolorful{k}{let} \PYGcolorful{n+nb+bp}{()} \PYGcolorful{o}{=} \PYGcolorful{k}{try}
                \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t1} \PYGcolorful{n}{t2} \PYGcolorful{n}{e2}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
              \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Typing\PYGcolorfulZus{}error} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t2} \PYGcolorful{n}{t1} \PYGcolorful{n}{e1}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
            \PYGcolorful{k}{in} \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{))} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool}

          \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
            \PYGcolorful{k}{begin}
              \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
                \PYGcolorful{k}{match} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n}{print\PYGcolorfulZus{}to\PYGcolorfulZus{}string} \PYGcolorful{n}{print\PYGcolorfulZus{}binop} \PYGcolorful{n}{b}\PYGcolorful{o}{)}
                                            \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)} \PYGcolorful{o}{[}\PYGcolorful{n}{e1}\PYGcolorful{o}{;} \PYGcolorful{n}{e2}\PYGcolorful{o}{]} \PYGcolorful{k}{with}
              \PYGcolorful{o}{|} \PYGcolorful{o}{([}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{;} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{],} \PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{},} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)}
              \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
              \PYGcolorful{k}{in}
              \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{e1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{,} \PYGcolorful{n}{e2\PYGcolorfulZsq{}}\PYGcolorful{o}{))} \PYGcolorful{n}{t}
            \PYGcolorful{k}{end}
        \PYGcolorful{k}{end}

      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Enew} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{k}{if} \PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}new} \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This form isn\PYGcolorfulZsq{}t allowed\PYGcolorfulZdq{}} \PYGcolorful{n}{expr}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
        \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{k}{in}
        \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Enew} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{to\PYGcolorfulZus{}access} \PYGcolorful{n}{t}\PYGcolorful{o}{)}

      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eapp\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{f}\PYGcolorful{o}{,} \PYGcolorful{n}{params}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} 
        \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n}{modes}\PYGcolorful{o}{,} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{n}{env} \PYGcolorful{n}{f} \PYGcolorful{n}{params} \PYGcolorful{k}{in}
        \PYGcolorful{k}{let} \PYGcolorful{n}{pf\PYGcolorfulZus{}sig} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{name} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}pf\PYGcolorfulZus{}id} \PYGcolorful{n}{env} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{;}
                         \PYGcolorful{n}{modes}\PYGcolorful{o}{;}
                         \PYGcolorful{n}{level} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{level} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZhy{}} \PYGcolorful{n}{lvl}\PYGcolorful{o}{;}
                         \PYGcolorful{n}{size\PYGcolorfulZus{}ret} \PYGcolorful{o}{=} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
        \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eapp\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{pf\PYGcolorfulZus{}sig}\PYGcolorful{o}{,} \PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{))} \PYGcolorful{n}{t}

      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
    \PYGcolorful{k}{end}


\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{o}{?(}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{n}{env} \PYGcolorful{n}{lv} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{not\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{n}{loc} \PYGcolorful{o}{=} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression should be a left value\PYGcolorfulZdq{}} \PYGcolorful{n}{loc} \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{n}{lv} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Lident} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{id\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{k}{in}
    \PYGcolorful{k}{begin}
      \PYGcolorful{k}{match} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{}}\PYGcolorful{n}{r}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{if} \PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{k}{then} \PYGcolorful{n}{not\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
        \PYGcolorful{k}{else} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eapp\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{))} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)}
      \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Eident} \PYGcolorful{n}{id\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{t}
    \PYGcolorful{k}{end}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Lmember} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{n}{f}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{begin}
      \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}new}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
      \PYGcolorful{k}{if} \PYGcolorful{n}{f}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}all\PYGcolorfulZdq{}} \PYGcolorful{k}{then}
        \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{t\PYGcolorfulZus{}deref}\PYGcolorful{o}{,} \PYGcolorful{n}{was\PYGcolorfulZus{}ac}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{deref} \PYGcolorful{n}{env} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{t} \PYGcolorful{k}{in}
        \PYGcolorful{k}{if} \PYGcolorful{n}{was\PYGcolorfulZus{}ac} \PYGcolorful{k}{then} \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Ederef} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{t\PYGcolorfulZus{}deref}
        \PYGcolorful{k}{else} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression should be an access\PYGcolorfulZdq{}} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
      \PYGcolorful{k}{else}
        \PYGcolorful{k}{match} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def} \PYGcolorful{k}{with}
        \PYGcolorful{o}{|} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Trecord} \PYGcolorful{n}{r} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
          \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{t\PYGcolorfulZus{}field}\PYGcolorful{o}{,} \PYGcolorful{n}{offs}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}field} \PYGcolorful{n}{env} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{n}{r} \PYGcolorful{n}{f} \PYGcolorful{k}{in}
          \PYGcolorful{k}{if} \PYGcolorful{n}{ensure\PYGcolorfulZus{}lv}
          \PYGcolorful{k}{then} \PYGcolorful{n}{ignore} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{env} \PYGcolorful{n}{e}\PYGcolorful{o}{);}
          \PYGcolorful{c}{(* ineffective, but simpler *)}
          \PYGcolorful{n}{deco\PYGcolorfulZus{}expr} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Emember} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{offs}\PYGcolorful{o}{))} \PYGcolorful{n}{t\PYGcolorfulZus{}field}

        \PYGcolorful{o}{|} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Taccess} \PYGcolorful{n}{r} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
          \PYGcolorful{n}{type\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv} \PYGcolorful{n}{env}
            \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{o}{(}\PYGcolorful{n+nc}{Lmember} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Eleft\PYGcolorfulZus{}val} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Lmember} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{n}{decorate} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}all\PYGcolorfulZdq{}} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)))}
                          \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{,} \PYGcolorful{n}{f}\PYGcolorful{o}{))}
        \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}This expression should be a record or an \PYGcolorfulZbs{}}
\PYGcolorful{l+s+s2}{                                      access on a record\PYGcolorfulZdq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}        
    \PYGcolorful{k}{end}


\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{o}{?(}\PYGcolorful{n}{expr} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{true}\PYGcolorful{o}{)} \PYGcolorful{n}{env} \PYGcolorful{n}{name} \PYGcolorful{n}{params} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{typ}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{name} \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{o}{(}\PYGcolorful{n}{typ}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def}\PYGcolorful{o}{,} \PYGcolorful{n}{expr}\PYGcolorful{o}{)} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{t}\PYGcolorful{o}{),} \PYGcolorful{n+nb+bp}{true}\PYGcolorful{o}{)} \PYGcolorful{k}{when} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{null} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A procedure cannot be called in an expression\PYGcolorfulZdq{}} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
  \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{t}\PYGcolorful{o}{),} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{)} \PYGcolorful{k}{when} \PYGcolorful{n}{t} \PYGcolorful{o}{\PYGcolorfulZlt{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{null} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A function cannot be applied in a statement\PYGcolorfulZdq{}} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
  \PYGcolorful{o}{|} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{l}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{),} \PYGcolorful{o}{\PYGcolorfulZus{})} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin}
      \PYGcolorful{k}{try}
        \PYGcolorful{k}{let} \PYGcolorful{n}{params\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map2}
                        \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
                           \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{te}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n}{m} \PYGcolorful{k}{with}
                             \PYGcolorful{o}{|} \PYGcolorful{n+nc}{In} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e}
                             \PYGcolorful{o}{|} \PYGcolorful{n+nc}{InOut} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
                               \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{te}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
                               \PYGcolorful{n}{expr\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{e}\PYGcolorful{o}{;} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{te}\PYGcolorful{o}{)}
                           \PYGcolorful{k}{in}
                           \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t} \PYGcolorful{n}{te} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
                           \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{l} \PYGcolorful{n}{params} \PYGcolorful{k}{in}
        \PYGcolorful{o}{(}\PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{r}\PYGcolorful{o}{,} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{n}{snd} \PYGcolorful{n}{l}\PYGcolorful{o}{,} \PYGcolorful{n}{typ}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{)}
      \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Invalid\PYGcolorfulZus{}argument} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{c}{(* \PYGcolorfulZdq{}List.map2\PYGcolorfulZdq{} *)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s expects \PYGcolorfulZpc{}d arguments but is given \PYGcolorfulZpc{}d here\PYGcolorfulZdq{}}
                 \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{length} \PYGcolorful{n}{l}\PYGcolorful{o}{)} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{length} \PYGcolorful{n}{params}\PYGcolorful{o}{))} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{end}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{fp}\PYGcolorful{o}{,} \PYGcolorful{n}{v}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{k}{if} \PYGcolorful{n}{expr} \PYGcolorful{k}{then} \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}function\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}applied\PYGcolorfulZdq{}}\PYGcolorful{o}{)}
           \PYGcolorful{k}{else} \PYGcolorful{o}{(}\PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}procedure\PYGcolorfulZdq{}}\PYGcolorful{o}{,} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}called\PYGcolorfulZdq{}}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZpc{}s is not a \PYGcolorfulZpc{}s, it cannot be \PYGcolorfulZpc{}s\PYGcolorfulZdq{}} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{fp} \PYGcolorful{n}{v}\PYGcolorful{o}{)} \PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}


\PYGcolorful{c}{(** Typing of statements *)}

\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{stmt} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{stmt}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{lv}\PYGcolorful{o}{,} \PYGcolorful{n}{e}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{lv\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}left\PYGcolorfulZus{}val} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{ensure\PYGcolorfulZus{}lv}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{env} \PYGcolorful{n}{lv} \PYGcolorful{k}{in}
    \PYGcolorful{n}{lv\PYGcolorfulZus{}ensure\PYGcolorfulZus{}not\PYGcolorfulZus{}modified} \PYGcolorful{n}{env} \PYGcolorful{n}{lv}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{te}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{t} \PYGcolorful{n}{te} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{lv\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scall\PYGcolorfulZus{}proc} \PYGcolorful{o}{(}\PYGcolorful{n}{p}\PYGcolorful{o}{,} \PYGcolorful{n}{params}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{}}\PYGcolorful{n}{t}\PYGcolorful{o}{,} \PYGcolorful{n}{modes}\PYGcolorful{o}{,} \PYGcolorful{n}{lvl}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}proc\PYGcolorfulZus{}func} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{expr}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{false} \PYGcolorful{n}{env} \PYGcolorful{n}{p} \PYGcolorful{n}{params} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{pf\PYGcolorfulZus{}sig} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{name} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}pf\PYGcolorfulZus{}id} \PYGcolorful{n}{env} \PYGcolorful{n}{p}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{;}
                     \PYGcolorful{n}{modes}\PYGcolorful{o}{;}
                     \PYGcolorful{n}{level} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{level} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZhy{}} \PYGcolorful{n}{lvl}\PYGcolorful{o}{;}
                     \PYGcolorful{n}{size\PYGcolorfulZus{}ret} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{0} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scall\PYGcolorfulZus{}proc} \PYGcolorful{o}{(}\PYGcolorful{n}{pf\PYGcolorfulZus{}sig}\PYGcolorful{o}{,} \PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sreturn} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{t} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sreturn} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sblock} \PYGcolorful{n}{l} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{l\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{n}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{fold\PYGcolorfulZus{}left} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{l}\PYGcolorful{o}{,} \PYGcolorful{n}{n}\PYGcolorful{o}{)} \PYGcolorful{n}{s} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
                                   \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{s}\PYGcolorful{o}{,} \PYGcolorful{n}{v}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s} \PYGcolorful{k}{in}
                                   \PYGcolorful{o}{(}\PYGcolorful{n}{s} \PYGcolorful{o}{::} \PYGcolorful{n}{l}\PYGcolorful{o}{,} \PYGcolorful{n}{max} \PYGcolorful{n}{n} \PYGcolorful{n}{v}\PYGcolorful{o}{))} \PYGcolorful{o}{(}\PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{,} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{)} \PYGcolorful{n}{l} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sblock} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{rev} \PYGcolorful{n}{l\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{n}{n}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scond} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{n}{s1}\PYGcolorful{o}{,} \PYGcolorful{n}{s2}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool} \PYGcolorful{n}{t} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{s1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{n1}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s1} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{s2\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{n2}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s2} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scond} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{s1\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{s2\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{n}{max} \PYGcolorful{n}{n1} \PYGcolorful{n}{n2}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Swhile} \PYGcolorful{o}{(}\PYGcolorful{n}{e}\PYGcolorful{o}{,} \PYGcolorful{n}{s}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{bool} \PYGcolorful{n}{t} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{s\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{n}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Swhile} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{s\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{n}{n}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sfor} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n}{rev}\PYGcolorful{o}{,} \PYGcolorful{n}{lb}\PYGcolorful{o}{,} \PYGcolorful{n}{ub}\PYGcolorful{o}{,} \PYGcolorful{n}{s}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} 
    \PYGcolorful{k}{let} \PYGcolorful{n}{env} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{n}{id} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{dummy\PYGcolorfulZus{}ident} \PYGcolorful{n}{ofs} \PYGcolorful{o}{=}
      \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{is\PYGcolorfulZus{}reference} \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false}\PYGcolorful{o}{;} \PYGcolorful{n}{size} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{;} \PYGcolorful{n}{level} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{0}\PYGcolorful{o}{;} \PYGcolorful{n}{offset} \PYGcolorful{o}{=} \PYGcolorful{n}{ofs} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{process} \PYGcolorful{n}{env} \PYGcolorful{n}{b} \PYGcolorful{n}{id} \PYGcolorful{o}{=}
      \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{b\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{b} \PYGcolorful{k}{in}
      \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int} \PYGcolorful{n}{t} \PYGcolorful{n}{b}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
      \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{ofs}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate\PYGcolorfulZus{}dummy\PYGcolorfulZus{}loc} \PYGcolorful{n}{id}\PYGcolorful{o}{)} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{int} \PYGcolorful{k}{in}
      \PYGcolorful{o}{(}\PYGcolorful{n}{b\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{dummy\PYGcolorfulZus{}ident} \PYGcolorful{n}{ofs}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{lb\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{id\PYGcolorfulZus{}lb}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{process} \PYGcolorful{n}{env} \PYGcolorful{n}{lb} \PYGcolorful{o}{(}\PYGcolorful{n}{get\PYGcolorfulZus{}unique\PYGcolorfulZus{}id} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}lb\PYGcolorfulZdq{}}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{ub\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{id\PYGcolorfulZus{}ub}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{process} \PYGcolorful{n}{env} \PYGcolorful{n}{ub} \PYGcolorful{o}{(}\PYGcolorful{n}{get\PYGcolorfulZus{}unique\PYGcolorfulZus{}id} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}ub\PYGcolorfulZdq{}}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{ofs\PYGcolorfulZus{}i}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{n}{env} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{force}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true}
                          \PYGcolorful{o}{(\PYGcolorfulZob{}} \PYGcolorful{n}{ident} \PYGcolorful{o}{=} \PYGcolorful{n}{id}\PYGcolorful{o}{;}
                             \PYGcolorful{n}{ta} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{typ\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}integer\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
                                    \PYGcolorful{n}{is\PYGcolorfulZus{}access}  \PYGcolorful{o}{=} \PYGcolorful{n+nb+bp}{false} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{o}{\PYGcolorfulZcb{},} \PYGcolorful{n+nc}{In}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{id\PYGcolorfulZus{}i} \PYGcolorful{o}{=} \PYGcolorful{n}{dummy\PYGcolorfulZus{}ident} \PYGcolorful{n}{ofs\PYGcolorfulZus{}i} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{s\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{n}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{return\PYGcolorfulZus{}type} \PYGcolorful{n}{s} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{start\PYGcolorfulZus{}id}\PYGcolorful{o}{,} \PYGcolorful{n}{test\PYGcolorfulZus{}op}\PYGcolorful{o}{,} \PYGcolorful{n}{test\PYGcolorfulZus{}id}\PYGcolorful{o}{,} \PYGcolorful{n}{incr\PYGcolorfulZus{}op}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
      \PYGcolorful{k}{if} \PYGcolorful{n}{rev} \PYGcolorful{k}{then} \PYGcolorful{o}{(}\PYGcolorful{n}{id\PYGcolorfulZus{}ub}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Bgeq}\PYGcolorful{o}{,} \PYGcolorful{n}{id\PYGcolorfulZus{}lb}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Bminus}\PYGcolorful{o}{)}
      \PYGcolorful{k}{else} \PYGcolorful{o}{(}\PYGcolorful{n}{id\PYGcolorfulZus{}lb}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Bleq}\PYGcolorful{o}{,} \PYGcolorful{n}{id\PYGcolorfulZus{}ub}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Bplus}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{k}{open} \PYGcolorful{n+nc}{T} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{to\PYGcolorfulZus{}expr} \PYGcolorful{n}{id} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Eident} \PYGcolorful{n}{id}\PYGcolorful{o}{)} \PYGcolorful{l+m+mi}{1} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{expr\PYGcolorfulZus{}i} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}expr} \PYGcolorful{n}{id\PYGcolorfulZus{}i} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{expr\PYGcolorfulZus{}test\PYGcolorfulZus{}id} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}expr} \PYGcolorful{n}{test\PYGcolorfulZus{}id} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{expr\PYGcolorfulZus{}1} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Econst} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Cint} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{))} \PYGcolorful{l+m+mi}{1} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{expr\PYGcolorfulZus{}incr} \PYGcolorful{o}{=} \PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{expr\PYGcolorfulZus{}i}\PYGcolorful{o}{,} \PYGcolorful{n}{incr\PYGcolorfulZus{}op}\PYGcolorful{o}{,} \PYGcolorful{n}{expr\PYGcolorfulZus{}1}\PYGcolorful{o}{))} \PYGcolorful{l+m+mi}{1} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{start} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{expr\PYGcolorfulZus{}i}\PYGcolorful{o}{,} \PYGcolorful{n}{to\PYGcolorfulZus{}expr} \PYGcolorful{n}{start\PYGcolorfulZus{}id}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{test} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Ebinop} \PYGcolorful{o}{(}\PYGcolorful{n}{expr\PYGcolorfulZus{}i}\PYGcolorful{o}{,} \PYGcolorful{n}{test\PYGcolorfulZus{}op}\PYGcolorful{o}{,} \PYGcolorful{n}{expr\PYGcolorfulZus{}test\PYGcolorfulZus{}id}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{incr} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{expr\PYGcolorfulZus{}i}\PYGcolorful{o}{,} \PYGcolorful{n}{expr\PYGcolorfulZus{}incr}\PYGcolorful{o}{)} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sblock} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{[}\PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{to\PYGcolorfulZus{}expr} \PYGcolorful{n}{id\PYGcolorfulZus{}lb}\PYGcolorful{o}{,} \PYGcolorful{n}{lb\PYGcolorfulZsq{}}\PYGcolorful{o}{);} \PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{(}\PYGcolorful{n}{to\PYGcolorfulZus{}expr} \PYGcolorful{n}{id\PYGcolorfulZus{}ub}\PYGcolorful{o}{,} \PYGcolorful{n}{ub\PYGcolorfulZsq{}}\PYGcolorful{o}{);} \PYGcolorful{n}{start}\PYGcolorful{o}{;}
                 \PYGcolorful{n+nc}{Swhile} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{n}{test} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Sblock} \PYGcolorful{o}{[}\PYGcolorful{n}{s\PYGcolorfulZsq{}}\PYGcolorful{o}{;} \PYGcolorful{n}{incr}\PYGcolorful{o}{])],} \PYGcolorful{n}{n} \PYGcolorful{o}{+} \PYGcolorful{l+m+mi}{3}\PYGcolorful{o}{)}


\PYGcolorful{c}{(** Typing of declarations *)}

\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{loc} \PYGcolorful{n}{stmts} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{try\PYGcolorfulZus{}ret} \PYGcolorful{n}{l} \PYGcolorful{n}{b2} \PYGcolorful{o}{=} \PYGcolorful{k}{try} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{iter} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{loc}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{loc} \PYGcolorful{n}{b}\PYGcolorful{o}{)} \PYGcolorful{n}{l}
    \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Typing\PYGcolorfulZus{}error} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{loc\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{loc\PYGcolorfulZsq{}} \PYGcolorful{n}{b2}
  \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{n}{stmts} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Function \PYGcolorfulZpc{}s does not always end with a return\PYGcolorfulZdq{}}
                   \PYGcolorful{n}{name}\PYGcolorful{o}{)} \PYGcolorful{n}{loc}
  \PYGcolorful{o}{|} \PYGcolorful{n}{s} \PYGcolorful{o}{::} \PYGcolorful{n}{tl} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin}
      \PYGcolorful{k}{match} \PYGcolorful{n}{s}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Saffect} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scall\PYGcolorfulZus{}proc} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Swhile} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sfor} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{name} \PYGcolorful{n}{s}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{tl}
      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sreturn} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{begin} \PYGcolorful{k}{match} \PYGcolorful{n}{tl} \PYGcolorful{k}{with}
          \PYGcolorful{o}{|} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}
          \PYGcolorful{o}{|} \PYGcolorful{n}{s} \PYGcolorful{o}{::} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{report} \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{warning}\PYGcolorful{o}{:}\PYGcolorful{n+nb+bp}{true} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZdq{}} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Dead code\PYGcolorfulZdq{}} \PYGcolorful{n}{s}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
        \PYGcolorful{k}{end}
      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Sblock} \PYGcolorful{n}{b} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{try\PYGcolorfulZus{}ret} \PYGcolorful{o}{[(}\PYGcolorful{n}{loc}\PYGcolorful{o}{,} \PYGcolorful{n}{b}\PYGcolorful{o}{)]} \PYGcolorful{n}{tl}
      \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Scond} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{s1}\PYGcolorful{o}{,} \PYGcolorful{n}{s2}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{try\PYGcolorfulZus{}ret} \PYGcolorful{o}{[(}\PYGcolorful{n}{s1}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{,} \PYGcolorful{o}{[}\PYGcolorful{n}{s1}\PYGcolorful{o}{]);} \PYGcolorful{o}{(}\PYGcolorful{n}{s2}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{,} \PYGcolorful{o}{[}\PYGcolorful{n}{s2}\PYGcolorful{o}{])]} \PYGcolorful{n}{tl}
    \PYGcolorful{k}{end}


\PYGcolorful{k}{let} \PYGcolorful{k}{rec} \PYGcolorful{n}{type\PYGcolorfulZus{}decl} \PYGcolorful{n}{env} \PYGcolorful{n}{d} \PYGcolorful{o}{=}
  \PYGcolorful{k}{let} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{id} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{deco\PYGcolorfulZus{}level} \PYGcolorful{n}{env} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{in}
  \PYGcolorful{k}{match} \PYGcolorful{n}{d} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dtype\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{None}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nc}{None}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dtype\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{ta}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{if} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}A type cannot be an access on itself\PYGcolorfulZdq{}} \PYGcolorful{n}{id}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{ta} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{t\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t} \PYGcolorful{k}{with} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id} \PYGcolorful{n}{t\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}subtypes} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{t\PYGcolorfulZsq{}} \PYGcolorful{n}{t} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nc}{None}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Drecord\PYGcolorfulZus{}def} \PYGcolorful{o}{(}\PYGcolorful{n}{id}\PYGcolorful{o}{,} \PYGcolorful{n}{fields}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZus{}with\PYGcolorfulZus{}r} \PYGcolorful{o}{=} \PYGcolorful{k}{try}
        \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{n}{id}
      \PYGcolorful{k}{with} \PYGcolorful{n+nc}{Typing\PYGcolorfulZus{}error} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{env} \PYGcolorful{c}{(* r already declared *)} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{idents} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{a} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{)} \PYGcolorful{n}{fields} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n+nb+bp}{()} \PYGcolorful{o}{=} \PYGcolorful{k}{match} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{find\PYGcolorfulZus{}duplicates}
                     \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{i} \PYGcolorful{n}{i\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{String}\PYGcolorful{p}{.}\PYGcolorful{n}{compare} \PYGcolorful{n}{i}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{idents} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{None} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nb+bp}{()}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Some} \PYGcolorful{o}{(\PYGcolorfulZus{},} \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Field \PYGcolorfulZpc{}s has already been declared\PYGcolorfulZdq{}}
                               \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{i\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}
    \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{size} \PYGcolorful{o}{=} \PYGcolorful{n}{ref} \PYGcolorful{l+m+mi}{0} \PYGcolorful{k}{in} \PYGcolorful{c}{(* ugly... *)}
    \PYGcolorful{k}{let} \PYGcolorful{n}{fields\PYGcolorfulZus{}t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{a} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
                              \PYGcolorful{k}{let} \PYGcolorful{n}{t} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env\PYGcolorfulZus{}with\PYGcolorfulZus{}r} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta} \PYGcolorful{k}{in}
                              \PYGcolorful{n}{size} \PYGcolorful{o}{:=} \PYGcolorful{o}{!}\PYGcolorful{n}{size} \PYGcolorful{o}{+} \PYGcolorful{n}{t}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size}\PYGcolorful{o}{;}
                              \PYGcolorful{n}{map\PYGcolorfulZus{}a} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{id} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{replace\PYGcolorfulZus{}deco} \PYGcolorful{n}{id} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}level} \PYGcolorful{n}{t}\PYGcolorful{o}{))} \PYGcolorful{n}{a}\PYGcolorful{o}{)}
                     \PYGcolorful{n}{fields} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}typ\PYGcolorfulZus{}ident\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{id}
                 \PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{id}\PYGcolorful{o}{;}
                   \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Trecord} \PYGcolorful{n}{fields\PYGcolorfulZus{}t}\PYGcolorful{o}{;}
                   \PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{=} \PYGcolorful{o}{!}\PYGcolorful{n}{size} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nc}{None}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dvar\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{e}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}undefined} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{typ} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta} \PYGcolorful{k}{in}
    \PYGcolorful{k}{if} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}
    \PYGcolorful{k}{then} \PYGcolorful{n}{error} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Format}\PYGcolorful{p}{.}\PYGcolorful{n}{sprintf} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}Object \PYGcolorfulZpc{}s cannot be used before the end of its }\PYGcolorful{l+s+se}{\PYGcolorfulZbs{}\PYGcolorfulZbs{}}
\PYGcolorful{l+s+s2}{                  declaration\PYGcolorfulZdq{}} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{begin} \PYGcolorful{k}{match} \PYGcolorful{n}{e} \PYGcolorful{k}{with}
      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{None} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{o}{\PYGcolorfulZus{}}\PYGcolorful{n}{offs}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{n}{typ} \PYGcolorful{k}{in}
        \PYGcolorful{o}{(}\PYGcolorful{n+nc}{None}\PYGcolorful{o}{,}
         \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}

      \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{e} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
        \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{t}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}expr} \PYGcolorful{n}{env} \PYGcolorful{n}{e} \PYGcolorful{k}{in}
        \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}subtype} \PYGcolorful{n}{env} \PYGcolorful{n}{typ} \PYGcolorful{n}{t} \PYGcolorful{n}{e}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
        \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{offs}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident} \PYGcolorful{n}{typ} \PYGcolorful{k}{in}
        \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Some} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dvar\PYGcolorfulZus{}decl} \PYGcolorful{o}{(}\PYGcolorful{n}{offs}\PYGcolorful{o}{,} \PYGcolorful{n}{e\PYGcolorfulZsq{}}\PYGcolorful{o}{)),}
         \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}not\PYGcolorfulZus{}const} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc}\PYGcolorful{o}{)}
    \PYGcolorful{k}{end}

  \PYGcolorful{o}{|} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{pf} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}
    \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{n}{env} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco}\PYGcolorful{o}{;}
    \PYGcolorful{k}{let} \PYGcolorful{n}{is\PYGcolorfulZus{}proc} \PYGcolorful{o}{=} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{return}\PYGcolorful{o}{.}\PYGcolorful{n}{typ\PYGcolorfulZus{}ident}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{o}{=} \PYGcolorful{l+s+s2}{\PYGcolorfulZdq{}\PYGcolorfulZdq{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{return\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{k}{if} \PYGcolorful{n}{is\PYGcolorfulZus{}proc} \PYGcolorful{k}{then} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{null} \PYGcolorful{k}{else} \PYGcolorful{k}{begin}
        \PYGcolorful{n}{ensure\PYGcolorfulZus{}return} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{o}{[}\PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{stmt}\PYGcolorful{o}{];}
        \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{return}
      \PYGcolorful{k}{end} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{params\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{o}{(}\PYGcolorful{n}{a}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}typ\PYGcolorfulZus{}annot\PYGcolorfulZus{}type} \PYGcolorful{n}{env} \PYGcolorful{n}{a}\PYGcolorful{o}{.}\PYGcolorful{n}{ta}\PYGcolorful{o}{,} \PYGcolorful{n}{m}\PYGcolorful{o}{))}
                    \PYGcolorful{c}{(* ensures wf *)} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{params} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{id\PYGcolorfulZus{}pf} \PYGcolorful{o}{=} \PYGcolorful{n}{get\PYGcolorfulZus{}unique\PYGcolorfulZus{}id} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{add\PYGcolorfulZus{}pf} \PYGcolorful{n}{env2} \PYGcolorful{o}{=}
      \PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}id\PYGcolorfulZus{}type} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{register\PYGcolorfulZus{}pf} \PYGcolorful{n}{env2} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{.}\PYGcolorful{n}{desc} \PYGcolorful{n}{id\PYGcolorfulZus{}pf}\PYGcolorful{o}{)}
             \PYGcolorful{o}{\PYGcolorfulZti{}}\PYGcolorful{n}{lvl}\PYGcolorful{o}{:(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{level} \PYGcolorful{n}{env}\PYGcolorful{o}{)} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{name}
             \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{t\PYGcolorfulZus{}ident} \PYGcolorful{o}{=} \PYGcolorful{n}{to\PYGcolorfulZus{}t\PYGcolorfulZus{}id} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{name}\PYGcolorful{o}{;}
                 \PYGcolorful{n}{def} \PYGcolorful{o}{=} \PYGcolorful{n+nc}{Tproc\PYGcolorfulZus{}func} \PYGcolorful{o}{(}\PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{return\PYGcolorfulZsq{}}\PYGcolorful{o}{);}
                 \PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{=} \PYGcolorful{l+m+mi}{0} \PYGcolorful{o}{\PYGcolorfulZcb{})} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{env\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{fold\PYGcolorfulZus{}left} \PYGcolorful{o}{(}\PYGcolorful{k}{fun} \PYGcolorful{n}{env} \PYGcolorful{n}{p} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{set\PYGcolorfulZus{}param} \PYGcolorful{n}{env} \PYGcolorful{n}{p}\PYGcolorful{o}{))}
                 \PYGcolorful{o}{(}\PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{incr\PYGcolorfulZus{}level} \PYGcolorful{n}{env}\PYGcolorful{o}{)} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{params} \PYGcolorful{k}{in}
    \PYGcolorful{c}{(* Adding pf after params and return, thanks to the absurd shadowing rules *)}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{decls\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}decls} \PYGcolorful{o}{(}\PYGcolorful{n}{add\PYGcolorfulZus{}pf} \PYGcolorful{n}{env\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{stmt}\PYGcolorful{o}{.}\PYGcolorful{n}{deco} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{decls} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{stmt\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{n\PYGcolorfulZus{}for}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}stmt} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{n}{return\PYGcolorfulZsq{}} \PYGcolorful{n}{pf}\PYGcolorful{o}{.}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{stmt} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{stmt\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{(}\PYGcolorful{n+nc}{Sblock} \PYGcolorful{o}{[}\PYGcolorful{n}{stmt\PYGcolorfulZsq{}}\PYGcolorful{o}{;} \PYGcolorful{n+nc}{Sreturn} \PYGcolorful{o}{(}\PYGcolorful{n}{decorate} \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Econst} \PYGcolorful{n+nc}{Cnull}\PYGcolorful{o}{)} \PYGcolorful{l+m+mi}{1}\PYGcolorful{o}{)])} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{pf\PYGcolorfulZus{}sig} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{name} \PYGcolorful{o}{=} \PYGcolorful{n}{id\PYGcolorfulZus{}pf}\PYGcolorful{o}{;}
                     \PYGcolorful{n}{modes} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{List}\PYGcolorful{p}{.}\PYGcolorful{n}{map} \PYGcolorful{n}{snd} \PYGcolorful{n}{params\PYGcolorfulZsq{}}\PYGcolorful{o}{;}
                     \PYGcolorful{n}{level} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{level} \PYGcolorful{n}{env}\PYGcolorful{o}{;}
                     \PYGcolorful{n}{size\PYGcolorfulZus{}ret} \PYGcolorful{o}{=} \PYGcolorful{k}{if} \PYGcolorful{n}{is\PYGcolorfulZus{}proc} \PYGcolorful{k}{then} \PYGcolorful{l+m+mi}{0} \PYGcolorful{k}{else} \PYGcolorful{n}{return\PYGcolorfulZsq{}}\PYGcolorful{o}{.}\PYGcolorful{n}{t\PYGcolorfulZus{}size} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{ret} \PYGcolorful{o}{=} \PYGcolorful{k}{if} \PYGcolorful{n}{is\PYGcolorfulZus{}proc} \PYGcolorful{k}{then} \PYGcolorful{l+m+mi}{0} \PYGcolorful{k}{else} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}ret\PYGcolorfulZus{}ofs} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{n}{pf\PYGcolorfulZsq{}} \PYGcolorful{o}{=} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{o}{\PYGcolorfulZob{}} \PYGcolorful{n}{pf\PYGcolorfulZus{}sig}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{frame} \PYGcolorful{o}{=} \PYGcolorful{n}{n\PYGcolorfulZus{}for} \PYGcolorful{o}{+} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{get\PYGcolorfulZus{}frame\PYGcolorfulZus{}size} \PYGcolorful{n}{env\PYGcolorfulZsq{}\PYGcolorfulZsq{}}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{ret}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{decls} \PYGcolorful{o}{=} \PYGcolorful{n}{decls\PYGcolorfulZsq{}}\PYGcolorful{o}{;}
                  \PYGcolorful{n}{stmt} \PYGcolorful{o}{=} \PYGcolorful{k}{if} \PYGcolorful{n}{is\PYGcolorfulZus{}proc} \PYGcolorful{k}{then} \PYGcolorful{n}{stmt\PYGcolorfulZsq{}\PYGcolorfulZsq{}} \PYGcolorful{k}{else} \PYGcolorful{n}{stmt\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZcb{}} \PYGcolorful{k}{in}
    \PYGcolorful{o}{(}\PYGcolorful{n+nc}{Some} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{pf\PYGcolorfulZsq{}}\PYGcolorful{o}{),} \PYGcolorful{n}{add\PYGcolorfulZus{}pf} \PYGcolorful{n}{env}\PYGcolorful{o}{)}

\PYGcolorful{o+ow}{and} \PYGcolorful{n}{type\PYGcolorfulZus{}decls} \PYGcolorful{n}{env} \PYGcolorful{n}{loc\PYGcolorfulZus{}after} \PYGcolorful{n}{decls} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{decls} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nb+bp}{[]} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{ensure\PYGcolorfulZus{}all\PYGcolorfulZus{}def} \PYGcolorful{n}{env} \PYGcolorful{n}{loc\PYGcolorfulZus{}after}\PYGcolorful{o}{;} \PYGcolorful{o}{(}\PYGcolorful{n+nb+bp}{[]}\PYGcolorful{o}{,} \PYGcolorful{n}{env}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{n}{d} \PYGcolorful{o}{::} \PYGcolorful{n}{ds} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{d\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZus{}d}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}decl} \PYGcolorful{n}{env} \PYGcolorful{n}{d} \PYGcolorful{k}{in}
    \PYGcolorful{k}{let} \PYGcolorful{o}{(}\PYGcolorful{n}{ds\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZus{}ds}\PYGcolorful{o}{)} \PYGcolorful{o}{=} \PYGcolorful{n}{type\PYGcolorfulZus{}decls} \PYGcolorful{n}{env\PYGcolorfulZus{}d} \PYGcolorful{n}{loc\PYGcolorfulZus{}after} \PYGcolorful{n}{ds} \PYGcolorful{k}{in}
    \PYGcolorful{k}{match} \PYGcolorful{n}{d\PYGcolorfulZsq{}} \PYGcolorful{k}{with}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{None} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{ds\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZus{}ds}\PYGcolorful{o}{)}
    \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Some} \PYGcolorful{n}{d\PYGcolorfulZsq{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}}  \PYGcolorful{o}{(}\PYGcolorful{n}{d\PYGcolorfulZsq{}} \PYGcolorful{o}{::} \PYGcolorful{n}{ds\PYGcolorfulZsq{}}\PYGcolorful{o}{,} \PYGcolorful{n}{env\PYGcolorfulZus{}ds}\PYGcolorful{o}{)}


\PYGcolorful{c}{(** Typing of a program *)}

\PYGcolorful{k}{let} \PYGcolorful{n}{type\PYGcolorfulZus{}ast} \PYGcolorful{o}{(}\PYGcolorful{n}{a} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n}{ast}\PYGcolorful{o}{)} \PYGcolorful{o}{=}
  \PYGcolorful{k}{match} \PYGcolorful{n}{fst} \PYGcolorful{o}{(}\PYGcolorful{n}{type\PYGcolorfulZus{}decl} \PYGcolorful{n+nn}{Env}\PYGcolorful{p}{.}\PYGcolorful{n}{new\PYGcolorfulZus{}env} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{A}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{a}\PYGcolorful{o}{))} \PYGcolorful{k}{with}
  \PYGcolorful{o}{|} \PYGcolorful{n+nc}{Some} \PYGcolorful{o}{(}\PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n+nc}{Dproc\PYGcolorfulZus{}func} \PYGcolorful{n}{a\PYGcolorfulZsq{}}\PYGcolorful{o}{)} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{o}{(}\PYGcolorful{n}{a\PYGcolorfulZsq{}} \PYGcolorful{o}{:} \PYGcolorful{n+nn}{T}\PYGcolorful{p}{.}\PYGcolorful{n}{ast}\PYGcolorful{o}{)}
  \PYGcolorful{o}{|} \PYGcolorful{o}{\PYGcolorfulZus{}} \PYGcolorful{o}{\PYGcolorfulZhy{}\PYGcolorfulZgt{}} \PYGcolorful{k}{assert} \PYGcolorful{n+nb+bp}{false}
\end{Verbatim}
